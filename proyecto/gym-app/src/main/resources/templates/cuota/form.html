<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::content})}">
<div th:fragment="content">
  <div class="mb-4">
    <h1 class="h3 mb-1">Nuevo valor de cuota</h1>
    <p class="text-muted mb-0">Definí el importe para el mes vigente o uno futuro.</p>
  </div>

  <div th:if="${error}" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i><span th:text="${error}"></span>
  </div>

  <form th:action="@{/admin/cuotas}" th:object="${form}" method="post" class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Año</label>
      <select class="form-select" th:field="*{anio}" id="anio-select" required>
        <option value="" disabled th:selected="${form.anio == null}">Seleccioná un año</option>
        <option th:each="anio : ${anios}" th:value="${anio}" th:text="${anio}"></option>
      </select>
      <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('anio')}" th:errors="*{anio}"></div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Mes</label>
      <select class="form-select" th:field="*{mes}" id="mes-select" required>
        <option value="" disabled th:selected="${form.mes == null}">Seleccioná un mes</option>
        <option th:each="mes, iter : ${meses}" th:value="${mes}" th:data-ordinal="${iter.index}" th:text="${#strings.capitalize(mes.name().toLowerCase())}"></option>
      </select>
      <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('mes')}" th:errors="*{mes}"></div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Valor</label>
      <div class="input-group">
        <span class="input-group-text">$</span>
        <input type="number" step="0.01" min="0.01" class="form-control" th:field="*{valor}" required>
      </div>
      <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('valor')}" th:errors="*{valor}"></div>
    </div>

    <div class="col-12">
      <small class="text-muted">Solo se permiten periodos iguales o posteriores al mes actual.</small>
    </div>

    <div class="col-12 d-flex gap-2 mt-2">
      <button type="submit" class="btn btn-primary">Guardar</button>
      <a class="btn btn-secondary" th:href="@{/admin/cuotas}">Cancelar</a>
    </div>
  </form>

  <script th:inline="javascript">
    const anioActual = /*[[${anioActual}]]*/ 0;
    const mesActual = /*[[${mesActual}]]*/ 1;

    const anioSelect = document.getElementById('anio-select');
    const mesSelect = document.getElementById('mes-select');

    function actualizarMeses() {
      const anioSeleccionado = parseInt(anioSelect.value, 10);
      Array.from(mesSelect.options).forEach(option => {
        if (!option.value) {
          return;
        }
        const ordinal = parseInt(option.dataset.ordinal, 10);
        const debeDeshabilitar = !Number.isNaN(ordinal) && anioSeleccionado === anioActual && ordinal + 1 < mesActual;
        option.disabled = debeDeshabilitar;
        if (debeDeshabilitar && option.selected) {
          mesSelect.selectedIndex = 0;
        }
      });
    }

    anioSelect.addEventListener('change', actualizarMeses);
    if (anioSelect.value) {
      actualizarMeses();
    }
  </script>
</div>
</html>
