<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::content})}">
<div th:fragment="content">
  <div class="mb-4">
    <h1 class="h3 mb-1">Gestión de rutinas</h1>
    <p class="text-muted mb-0">Creá, actualizá y completá las rutinas de entrenamiento de los socios.</p>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header">
          <h2 class="h5 mb-0">Nueva rutina</h2>
        </div>
        <div class="card-body">
          <div th:if="${#lists.isEmpty(profesores)}" class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>No hay profesores activos disponibles. Registrá al menos uno para crear rutinas.
          </div>

          <form th:action="@{/admin/rutinas/nueva}" th:object="${rutinaForm}" method="post" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Número de socio</label>
              <input type="number" class="form-control" min="1" th:field="*{numeroSocio}" required>
              <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('numeroSocio')}" th:errors="*{numeroSocio}"></div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Profesor</label>
              <select class="form-select" th:field="*{profesorId}" th:disabled="${#lists.isEmpty(profesores)}" required>
                <option value="" disabled th:selected="${rutinaForm.profesorId == null}">Seleccioná un profesor</option>
                <option th:each="profesor : ${profesores}" th:value="${profesor.id}" th:text="${profesor.nombreCompleto}"></option>
              </select>
              <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('profesorId')}" th:errors="*{profesorId}"></div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Fecha de inicio</label>
              <input type="date" class="form-control" th:field="*{fechaInicia}" required>
              <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('fechaInicia')}" th:errors="*{fechaInicia}"></div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Fecha de finalización</label>
              <input type="date" class="form-control" th:field="*{fechaFinaliza}" required>
              <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('fechaFinaliza')}" th:errors="*{fechaFinaliza}"></div>
            </div>

            <div class="col-12">
              <label class="form-label">Objetivo</label>
              <textarea class="form-control" rows="2" th:field="*{objetivo}" placeholder="Ej: mejorar fuerza de tren inferior" required></textarea>
              <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('objetivo')}" th:errors="*{objetivo}"></div>
            </div>

            <div class="col-12 d-flex gap-2">
              <button type="submit" class="btn btn-primary" th:disabled="${#lists.isEmpty(profesores)}">Crear rutina</button>
              <button type="reset" class="btn btn-outline-secondary">Limpiar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header">
          <h2 class="h5 mb-0">Buscar rutina vigente</h2>
        </div>
        <div class="card-body">
          <form class="row g-3" method="get" th:action="@{/admin/rutinas}">
            <div class="col-md-8">
              <label class="form-label">Número de socio</label>
              <input type="number" min="1" class="form-control" name="numeroSocio" th:value="${numeroSocio}" required>
            </div>
            <div class="col-md-4 align-self-end d-grid">
              <button class="btn btn-outline-primary">Buscar rutina</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div th:if="${mensaje}" class="alert" th:classappend="${mensajeTipo} == 'error' ? ' alert-danger' : ' alert-success'" role="alert">
    <i class="bi" th:classappend="${mensajeTipo} == 'error' ? ' bi-exclamation-circle me-2' : ' bi-check-circle me-2'"></i>
    <span th:text="${mensaje}"></span>
  </div>

  <div th:if="${rutinaNoEncontrada}" class="alert alert-warning" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>No se encontró una rutina en proceso para el socio indicado.
  </div>

  <div th:if="${rutina}" class="vstack gap-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-lg-4">
            <h2 class="h5 mb-1">Rutina actual</h2>
            <p class="text-muted mb-0">
              <strong th:text="${rutina.socio.numeroSocio}"></strong> -
              <span th:text="${rutina.socio.apellido}"></span>,
              <span th:text="${rutina.socio.nombre}"></span>
            </p>
            <p class="text-muted mb-0">
              <small>Profesor: <span th:text="${rutina.profesor.apellido}"></span>, <span th:text="${rutina.profesor.nombre}"></span></small>
            </p>
          </div>
          <div class="col-lg-3">
            <p class="mb-0"><strong>Inicio:</strong> <span th:text="${rutina.fechaInicia}"></span></p>
            <p class="mb-0"><strong>Fin:</strong> <span th:text="${rutina.fechaFinaliza}"></span></p>
          </div>
          <div class="col-lg-3">
            <p class="mb-0"><strong>Estado:</strong> <span class="badge text-bg-primary" th:classappend="${rutina.estadoRutina}=='FINALIZADA' ? ' text-bg-success' : (${rutina.estadoRutina}=='ANULADA' ? ' text-bg-secondary' : ' text-bg-primary')" th:text="${rutina.estadoRutina}"></span></p>
            <p class="mb-0"><strong>Objetivo:</strong> <span th:text="${rutina.objetivo}"></span></p>
          </div>
          <div class="col-lg-2">
            <form th:action="@{|/admin/rutinas/${rutina.id}/estado|}" method="post" class="d-flex gap-2">
              <input type="hidden" name="numeroSocio" th:value="${numeroSocio}">
              <select class="form-select form-select-sm" name="estado">
                <option th:each="estado : ${estados}" th:value="${estado}" th:text="${estado}"
                        th:selected="${estado} == ${rutina.estadoRutina}"></option>
              </select>
              <button class="btn btn-sm btn-outline-primary">Actualizar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Días de entrenamiento</h2>
        <form th:action="@{|/admin/rutinas/${rutina.id}/detalles|}" method="post" class="d-flex align-items-center gap-2">
          <input type="hidden" name="rutinaId" th:value="${rutina.id}">
          <input type="hidden" name="numeroSocio" th:value="${numeroSocio}">
          <label class="mb-0">Día</label>
          <select class="form-select form-select-sm" name="diaSemana" required>
            <option th:each="dia : ${diasSemana}" th:value="${dia}" th:text="${dia.displayName}"></option>
          </select>
          <button class="btn btn-sm btn-outline-primary">Agregar</button>
        </form>
      </div>
      <div class="card-body">
        <div th:if="${#lists.isEmpty(detalles)}" class="alert alert-info mb-0" role="alert">
          <i class="bi bi-info-circle me-2"></i>Aún no se registraron días para esta rutina.
        </div>

        <div th:each="detalle : ${detalles}" class="mb-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h3 class="h6 mb-0">
              <span th:text="${detalle.diaSemana != null ? 'Día ' + detalle.diaSemana.displayName : 'Día'}"></span>
            </h3>
            <span class="badge" th:classappend="${detalle.activo} ? ' text-bg-success' : ' text-bg-secondary'"
                  th:text="${detalle.activo} ? 'Activo' : 'Inactivo'"></span>
          </div>

          <div class="table-responsive mb-3">
            <table class="table table-sm table-striped">
              <thead class="table-light">
                <tr>
                  <th>Actividad</th>
                  <th>Grupo muscular</th>
                  <th>Series</th>
                  <th>Repeticiones</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="ejercicio : ${detalle.detalleEjercicios}">
                  <td th:text="${ejercicio.actividad}"></td>
                  <td th:text="${ejercicio.grupoMuscular}"></td>
                  <td th:text="${ejercicio.series}"></td>
                  <td th:text="${ejercicio.repeticiones}"></td>
                </tr>
                <tr th:if="${detalle.detalleEjercicios == null || #lists.isEmpty(detalle.detalleEjercicios)}">
                  <td colspan="4" class="text-center text-muted">Sin ejercicios asignados todavía.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <form th:action="@{|/admin/rutinas/${rutina.id}/detalles/${detalle.id}/ejercicios|}" method="post" class="row g-2 align-items-end">
            <input type="hidden" name="rutinaId" th:value="${rutina.id}">
            <input type="hidden" name="detalleDiarioId" th:value="${detalle.id}">
            <input type="hidden" name="numeroSocio" th:value="${numeroSocio}">

            <div class="col-md-4">
              <label class="form-label">Actividad</label>
              <input type="text" class="form-control form-control-sm" name="actividad" required>
            </div>
            <div class="col-md-2">
              <label class="form-label">Grupo</label>
              <select class="form-select form-select-sm" name="grupoMuscular" required>
                <option th:each="grupo : ${grupos}" th:value="${grupo}" th:text="${grupo}"></option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Series</label>
              <input type="number" class="form-control form-control-sm" name="series" min="1" required>
            </div>
            <div class="col-md-2">
              <label class="form-label">Repeticiones</label>
              <input type="number" class="form-control form-control-sm" name="repeticiones" min="1" required>
            </div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-sm btn-outline-primary">Agregar ejercicio</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">Rutinas finalizadas</h2>
      <div class="d-flex gap-2">
        <a th:if="${!verFinalizadas}" class="btn btn-sm btn-outline-primary" th:href="@{/admin/rutinas(verFinalizadas=true)}">
          Ver historial
        </a>
        <a th:if="${verFinalizadas}" class="btn btn-sm btn-outline-secondary" th:href="@{/admin/rutinas}">
          Ocultar
        </a>
      </div>
    </div>
    <div class="card-body">
      <div th:if="${!verFinalizadas}" class="text-muted small">
        Usá el botón "Ver historial" para consultar las rutinas finalizadas.
      </div>
      <div th:if="${verFinalizadas}">
        <div th:if="${#lists.isEmpty(rutinasFinalizadas)}" class="alert alert-info" role="alert">
          <i class="bi bi-info-circle me-2"></i>No hay rutinas finalizadas para mostrar.
        </div>
        <div th:if="${!#lists.isEmpty(rutinasFinalizadas)}" class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Socio</th>
                <th>Profesor</th>
                <th>Período</th>
                <th>Objetivo</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="item : ${rutinasFinalizadas}">
                <td>
                  <div><strong th:text="${item.socio.numeroSocio}"></strong></div>
                  <div class="text-muted small" th:text="${item.socio.apellido + ', ' + item.socio.nombre}"></div>
                </td>
                <td>
                  <div th:text="${item.profesor.apellido + ', ' + item.profesor.nombre}"></div>
                </td>
                <td>
                  <div><span th:text="${item.fechaInicia}"></span> - <span th:text="${item.fechaFinaliza}"></span></div>
                </td>
                <td th:text="${item.objetivo}"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
</html>
