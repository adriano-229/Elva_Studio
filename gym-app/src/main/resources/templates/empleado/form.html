<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::content})}">
<div th:fragment="content">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="bi bi-person-badge me-2"></i>
      [[${form.id} == null ? 'Nuevo empleado' : 'Editar empleado']]
    </h1>
    <a class="btn btn-outline-secondary" th:href="@{/admin/empleados}">
      <i class="bi bi-arrow-left me-1"></i>Volver
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form th:action="${form.id} == null ? @{/admin/empleados} : @{|/admin/empleados/${form.id}|}"
            th:object="${form}" method="post" class="row g-3 needs-validation" novalidate>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <input type="hidden" th:field="*{direccionId}">
        <input type="hidden" th:field="*{usuarioId}">

        <div class="col-12">
          <h6 class="text-muted text-uppercase">Datos personales</h6>
        </div>

        <div class="col-md-4">
          <label class="form-label">Nombre</label>
          <input type="text" class="form-control" th:field="*{nombre}" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}"></div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Apellido</label>
          <input type="text" class="form-control" th:field="*{apellido}" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('apellido')}" th:errors="*{apellido}"></div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Fecha de nacimiento</label>
          <input type="date" class="form-control" th:field="*{fechaNacimiento}" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('fechaNacimiento')}" th:errors="*{fechaNacimiento}"></div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Tipo de documento</label>
          <select class="form-select" th:field="*{tipoDocumento}" required>
            <option th:each="t : ${tiposDocumento}" th:value="${t}" th:text="${t}"></option>
          </select>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('tipoDocumento')}" th:errors="*{tipoDocumento}"></div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Número de documento</label>
          <input type="text" class="form-control" th:field="*{numeroDocumento}" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('numeroDocumento')}" th:errors="*{numeroDocumento}"></div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Teléfono</label>
          <input type="text" class="form-control" th:field="*{telefono}">
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('telefono')}" th:errors="*{telefono}"></div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Correo electrónico</label>
          <input type="email" class="form-control" th:field="*{correoElectronico}">
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('correoElectronico')}" th:errors="*{correoElectronico}"></div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Sucursal</label>
          <select class="form-select" th:field="*{sucursalId}" required>
            <option value="" disabled th:selected="${form.sucursalId == null}">Seleccioná una sucursal</option>
            <option th:each="s : ${sucursales}" th:value="${s.id}" th:text="${s.nombre}"></option>
          </select>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('sucursalId')}" th:errors="*{sucursalId}"></div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Rol</label>
          <select class="form-select" th:field="*{rol}" required>
            <option value="" disabled th:selected="${form.rol == null}">Seleccioná un rol</option>
            <option th:each="r : ${rolesEmpleado}" th:value="${r}" th:text="${r}"></option>
          </select>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('rol')}" th:errors="*{rol}"></div>
        </div>

        <div class="col-md-4 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" th:field="*{activo}" id="activoCheck">
            <label class="form-check-label" for="activoCheck">Activo</label>
          </div>
        </div>

        <div class="col-12 pt-2">
          <h6 class="text-muted text-uppercase">Dirección</h6>
        </div>

        <div class="col-md-3">
          <label class="form-label">País</label>
          <select id="pais" class="form-select">
            <option value="">-- Seleccionar --</option>
            <option th:each="p : ${paises}" th:value="${p.id}" th:text="${p.nombre}"></option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Provincia</label>
          <select id="provincia" class="form-select"></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Departamento</label>
          <select id="departamento" class="form-select"></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Localidad</label>
          <select id="localidad" class="form-select" th:field="*{localidadId}" th:attr="data-current=${form.localidadId}"></select>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('localidadId')}" th:errors="*{localidadId}"></div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Calle</label>
          <input class="form-control" th:field="*{calle}" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('calle')}" th:errors="*{calle}"></div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Número</label>
          <input class="form-control" th:field="*{numeracion}" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('numeracion')}" th:errors="*{numeracion}"></div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Barrio</label>
          <input class="form-control" th:field="*{barrio}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Manzana / Piso</label>
          <input class="form-control" th:field="*{manzanaPiso}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Casa / Depto</label>
          <input class="form-control" th:field="*{casaDepartamento}">
        </div>

        <div class="col-12">
          <label class="form-label">Referencia</label>
          <textarea class="form-control" th:field="*{referencia}"></textarea>
        </div>

        <div class="col-12 pt-2">
          <h6 class="text-muted text-uppercase">Cuenta de acceso</h6>
        </div>

        <div class="col-md-4">
          <label class="form-label">Nombre de usuario</label>
          <input type="text" class="form-control" th:field="*{nombreUsuario}" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('nombreUsuario')}" th:errors="*{nombreUsuario}"></div>
        </div>

        <div class="col-md-4">
        <label class="form-label">Clave</label>
        <input type="password" class="form-control" th:field="*{clave}">
        </div>

        <div class="col-12 mt-4 d-flex gap-2">
          <button class="btn btn-primary" type="submit"><i class="bi bi-check-lg me-1"></i>Guardar</button>
          <a class="btn btn-outline-secondary" th:href="@{/admin/empleados}"><i class="bi bi-x-lg me-1"></i>Cancelar</a>
        </div>
      </form>
    </div>
  </div>

  <script th:inline="javascript">
    async function load(url, params) {
      const qs = new URLSearchParams(params).toString();
      const res = await fetch(url + (qs ? `?${qs}` : ''));
      if (!res.ok) {
        throw new Error('Error cargando ubicación');
      }
      return res.json();
    }

    function fillSelect(sel, items, placeholder = '-- Seleccionar --') {
      const current = sel.getAttribute('data-current');
      sel.innerHTML = `<option value="">${placeholder}</option>`;
      items.forEach(i => {
        const selected = current && current === i.id ? 'selected' : '';
        sel.insertAdjacentHTML('beforeend', `<option value="${i.id}" ${selected}>${i.nombre}</option>`);
      });
      sel.dispatchEvent(new Event('change'));
    }

    const $pais = document.getElementById('pais');
    const $provincia = document.getElementById('provincia');
    const $departamento = document.getElementById('departamento');
    const $localidad = document.getElementById('localidad');

    $pais?.addEventListener('change', async () => {
      $provincia.dataset.current = '';
      $departamento.dataset.current = '';
      $localidad.dataset.current = '';
      $provincia.innerHTML = '<option value="">-- Seleccionar --</option>';
      $departamento.innerHTML = '<option value="">-- Seleccionar --</option>';
      $localidad.innerHTML = '<option value="">-- Seleccionar --</option>';
      if ($pais.value) {
        try {
          const provincias = await load('/api/ubicacion/provincias', { paisId: $pais.value });
          fillSelect($provincia, provincias);
        } catch (err) {
          console.error(err);
        }
      }
    });

    $provincia?.addEventListener('change', async () => {
      $departamento.dataset.current = '';
      $localidad.dataset.current = '';
      $departamento.innerHTML = '<option value="">-- Seleccionar --</option>';
      $localidad.innerHTML = '<option value="">-- Seleccionar --</option>';
      if ($provincia.value) {
        try {
          const departamentos = await load('/api/ubicacion/departamentos', { provinciaId: $provincia.value });
          fillSelect($departamento, departamentos);
        } catch (err) {
          console.error(err);
        }
      }
    });

    $departamento?.addEventListener('change', async () => {
      $localidad.dataset.current = $localidad.dataset.current || $localidad.value;
      $localidad.innerHTML = '<option value="">-- Seleccionar --</option>';
      if ($departamento.value) {
        try {
          const localidades = await load('/api/ubicacion/localidades', { departamentoId: $departamento.value });
          fillSelect($localidad, localidades);
        } catch (err) {
          console.error(err);
        }
      }
    });
  </script>
</div>
</html>
