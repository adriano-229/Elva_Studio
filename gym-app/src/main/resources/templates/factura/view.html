<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::content})}">

<div th:fragment="content" class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">Factura <span th:text="${factura.numeroFactura}"></span></h1>
      <small class="text-muted">Emitida el <span th:text="${factura.fechaFactura}"></span></small>
    </div>
    <a th:href="@{/admin/facturas}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Volver
    </a>
  </div>

  <div th:if="${mensaje}" class="alert" th:classappend=" ${mensajeTipo != null ? 'alert-' + mensajeTipo : 'alert-info'}" th:text="${mensaje}"></div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h6 text-uppercase text-muted">Resumen</h2>
          <div class="row">
            <div class="col-md-6">
              <div class="fw-semibold">Socio</div>
              <div th:text="${factura.socioNombre}"></div>
            </div>
            <div class="col-md-3">
              <div class="fw-semibold">Estado</div>
              <span class="badge"
                    th:classappend="${factura.estado.name()=='PAGADA'} ? ' text-bg-success' :
                                   (${factura.estado.name()=='ANULADA'} ? ' text-bg-secondary' : ' text-bg-warning')"
                    th:text="${factura.estado}"></span>
            </div>
            <div class="col-md-3" th:if="${factura.formaDePagoTexto}">
              <div class="fw-semibold">Forma de pago</div>
              <div th:text="${factura.formaDePagoTexto}"></div>
            </div>
          </div>

          <div class="table-responsive mt-3">
            <table class="table table-sm table-striped align-middle mb-0">
              <thead class="table-light">
              <tr>
                <th>Mes</th>
                <th>Año</th>
                <th class="text-end">Importe</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="d : ${factura.detalles}">
                <td th:text="${d.mes}"></td>
                <td th:text="${d.anio}"></td>
                <td class="text-end" th:text="${d.importe}"></td>
              </tr>
              </tbody>
              <tfoot>
              <tr>
                <th colspan="2" class="text-end">Total</th>
                <th class="text-end" th:text="${factura.totalPagado}"></th>
              </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm mb-3" th:if="${factura.estado.name() != 'PAGADA' and factura.estado.name() != 'ANULADA'}">
        <div class="card-header">
          <i class="bi bi-cash-coin me-1"></i>Confirmar pago manual
        </div>
        <div class="card-body">
          <div class="alert alert-warning" th:if="${sinFormasPago}" role="alert">
            No hay formas de pago presenciales disponibles. Crea una forma de pago de tipo EFECTIVO o TRANSFERENCIA para poder confirmar manualmente.
          </div>
          <form th:action="@{|/admin/facturas/${factura.id}/confirmar|}" method="post" th:object="${pagoForm}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="mb-3">
              <label class="form-label">Forma de pago</label>
              <select class="form-select" th:field="*{formaDePagoId}" required th:disabled="${sinFormasPago}">
                <option value="" disabled th:selected="${*{formaDePagoId} == null}">-- Seleccionar --</option>
                <option th:each="fp : ${formasPago}" th:value="${fp.id}" th:text="${fp.tipoPago}"></option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Observaciones</label>
              <input type="text" class="form-control" th:field="*{observacion}" placeholder="Ej: Caja principal" th:disabled="${sinFormasPago}">
            </div>
            <div class="mb-3">
              <label class="form-label">Comprobante / Nº operación</label>
              <input type="text" class="form-control" th:field="*{comprobante}" placeholder="Opcional" th:disabled="${sinFormasPago}">
            </div>
            <button class="btn btn-success w-100" type="submit" th:disabled="${sinFormasPago}">
              <i class="bi bi-check2-circle me-1"></i>Confirmar pago
            </button>
          </form>
        </div>
      </div>

      <div class="card shadow-sm" th:if="${factura.estado.name() != 'ANULADA'}">
        <div class="card-header text-bg-light">
          <i class="bi bi-x-circle me-1"></i>Anular factura
        </div>
        <div class="card-body">
          <form th:action="@{|/admin/facturas/${factura.id}/anular|}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="mb-2">
              <label class="form-label">Motivo</label>
              <input class="form-control" name="motivo" placeholder="Opcional">
            </div>
            <button class="btn btn-outline-danger w-100" onclick="return confirm('¿Anular la factura?')">
              Anular factura
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
</html>
