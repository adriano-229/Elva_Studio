<!-- src/main/resources/templates/socio/form.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><meta charset="UTF-8"><title>Socio</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"></head>
<body class="container py-4">
  <h1 class="h4 mb-3">Socio</h1>

  <form th:action="${#strings.isEmpty(form.id)} ? @{/admin/socios} : @{|/admin/socios/${form.id}|}"
        method="post" th:object="${form}">
    <div class="row g-3">
      <!-- Persona -->
      <div class="col-md-4">
        <label class="form-label">Nombre</label>
        <input class="form-control" th:field="*{nombre}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Apellido</label>
        <input class="form-control" th:field="*{apellido}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Fecha Nacimiento</label>
        <input type="date" class="form-control" th:field="*{fechaNacimiento}">
      </div>

      <div class="col-md-4">
        <label class="form-label">Tipo Doc</label>
        <select class="form-select" th:field="*{tipoDocumento}">
          <option th:each="t : ${tiposDoc}" th:text="${t}" th:value="${t}"></option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">N° Documento</label>
        <input class="form-control" th:field="*{numeroDocumento}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Teléfono</label>
        <input class="form-control" th:field="*{telefono}">
      </div>
      <div class="col-md-6">
        <label class="form-label">Email</label>
        <input class="form-control" th:field="*{correoElectronico}">
      </div>
      <div class="col-md-6">
        <label class="form-label">Sucursal</label>
        <select class="form-select" th:field="*{sucursalId}" required>
          <option value="" disabled th:selected="${form.sucursalId == null}">Seleccioná una sucursal</option>
          <option th:each="sucursal : ${sucursales}" th:value="${sucursal.id}" th:text="${sucursal.nombre}"></option>
        </select>
        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('sucursalId')}" th:errors="*{sucursalId}"></div>
      </div>

      <!-- Usuario (composición) -->
      <div class="col-12"><h5 class="mt-3">Usuario</h5></div>
      <div class="col-md-4">
        <label class="form-label">Usuario</label>
        <input class="form-control" th:field="*{nombreUsuario}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Clave</label>
        <input type="password" class="form-control" th:field="*{clave}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Rol</label>
        <select class="form-select" th:field="*{rol}">
          <option th:each="r : ${roles}" th:text="${r}" th:value="${r}"></option>
        </select>
      </div>

      <!-- Dirección (inline) -->
      <div class="col-12"><h5 class="mt-3">Dirección</h5></div>

      <div class="col-md-3">
        <label class="form-label">País</label>
        <select id="pais" class="form-select">
          <option value="">-- Seleccionar --</option>
          <option th:each="p : ${paises}" th:value="${p.id}" th:text="${p.nombre}"></option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Provincia</label>
        <select id="provincia" class="form-select"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Departamento</label>
        <select id="departamento" class="form-select"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Localidad</label>
        <select id="localidad" class="form-select" th:field="*{localidadId}"></select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Calle</label>
        <input class="form-control" th:field="*{calle}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Número</label>
        <input class="form-control" th:field="*{numeracion}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Barrio</label>
        <input class="form-control" th:field="*{barrio}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Manzana/Piso</label>
        <input class="form-control" th:field="*{manzanaPiso}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Casa/Depto</label>
        <input class="form-control" th:field="*{casaDepartamento}">
      </div>
      <div class="col-12">
        <label class="form-label">Referencia</label>
        <textarea class="form-control" th:field="*{referencia}"></textarea>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Guardar</button>
      <a class="btn btn-secondary" th:href="@{/admin/socios}">Volver</a>
    </div>
  </form>

<script>
async function load(url, params) {
  const qs = new URLSearchParams(params).toString();
  const res = await fetch(url + (qs ? `?${qs}` : ''));
  return res.json();
}
function fillSelect(sel, items, placeholder='-- Seleccionar --') {
  sel.innerHTML = `<option value="">${placeholder}</option>`;
  items.forEach(i => sel.insertAdjacentHTML('beforeend', `<option value="${i.id}">${i.nombre}</option>`));
}

const $pais = document.getElementById('pais');
const $provincia = document.getElementById('provincia');
const $departamento = document.getElementById('departamento');
const $localidad = document.getElementById('localidad');

$pais.addEventListener('change', async () => {
  fillSelect($provincia, []); fillSelect($departamento, []); fillSelect($localidad, []);
  if ($pais.value) fillSelect($provincia, await load('/api/ubicacion/provincias', {paisId: $pais.value}));
});
$provincia.addEventListener('change', async () => {
  fillSelect($departamento, []); fillSelect($localidad, []);
  if ($provincia.value) fillSelect($departamento, await load('/api/ubicacion/departamentos', {provinciaId: $provincia.value}));
});
$departamento.addEventListener('change', async () => {
  fillSelect($localidad, []);
  if ($departamento.value) fillSelect($localidad, await load('/api/ubicacion/localidades', {departamentoId: $departamento.value}));
});

// Pre-carga (editar): si ya hay localidadId, podrías reconstruir la cascada aquí con llamadas sucesivas.
</script>
</body>
</html>
