<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es"
      th:replace="~{layout :: layout(~{::body})}">
<body>
<div th:fragment="content">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">Mapa de proveedores</h1>
        <a class="btn btn-primary" th:href="@{/proveedores/nuevo}">+ Nuevo proveedor</a>
    </div>

    <div th:if="${#lists.isEmpty(proveedores)}" class="alert alert-info">
        No hay proveedores registrados todavía. Cargá alguno para ver el mapa en acción.
    </div>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <div id="map" style="height:520px;border-radius:12px;overflow:hidden;"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script th:inline="javascript">
        const defaultCenter = [-24.7821, -65.4238];
        const map = L.map('map', { zoomControl: true }).setView(defaultCenter, 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const proveedores = [];
        /*[# th:each="p : ${proveedores}"]*/
        proveedores.push({
            latitud: /*[[${p.latitud}]]*/,
            longitud: /*[[${p.longitud}]]*/,
            nombre: /*[[${#strings.escapeJavaScript(p.nombre)}]]*/,
            direccion: /*[[${#strings.escapeJavaScript(p.direccion != null ? p.direccion : 'Sin dirección')}]]*/
        });
        /*[/]*/

        const bounds = [];
        proveedores
            .filter(p => p.latitud != null && p.longitud != null)
            .forEach(p => {
                const marker = L.marker([p.latitud, p.longitud]).addTo(map);
                marker.bindPopup('<strong>' + p.nombre + '</strong><br>' + p.direccion);
                bounds.push([p.latitud, p.longitud]);
            });

        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [30, 30] });
        } else {
            map.setView(defaultCenter, 5);
        }
    </script>
</div>
</body>
</html>
