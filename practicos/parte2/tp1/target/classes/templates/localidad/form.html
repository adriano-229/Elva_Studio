<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::div})}">
<head>
  <title>Formulario Localidad</title>
</head>
<body>
<div>
  <h2 th:text="${localidad.id == null} ? 'Nueva Localidad' : 'Editar Localidad'"></h2>
  <form th:action="@{/localidades}" th:object="${localidad}" method="post">
    <input type="hidden" th:field="*{id}"/>

    <div>
      <label for="nombre">Nombre:</label>
      <input id="nombre" type="text" th:field="*{nombre}" required/>
    </div>

    <div>
      <label for="codigoPostal">Código Postal:</label>
      <input id="codigoPostal" type="number" th:field="*{codigoPostal}"/>
    </div>

    <!-- Selección en cascada: País → Provincia → Departamento → Localidad -->
    <div>
      <label for="pais">País:</label>
      <select id="pais" name="paisId" required>
        <option value="">-- Seleccione un País --</option>
        <option th:each="pais : ${paises}" th:value="${pais.id}" th:text="${pais.nombre}"
                th:selected="${localidad.departamento != null && localidad.departamento.provincia != null && localidad.departamento.provincia.pais.id == pais.id}"></option>
      </select>
    </div>

    <div>
      <label for="provincia">Provincia:</label>
      <select id="provincia" name="provinciaId" required disabled>
        <option value="">-- Seleccione una Provincia --</option>
      </select>
    </div>

    <div>
      <label for="departamento">Departamento:</label>
      <select id="departamento" th:field="*{departamento.id}" required disabled>
        <option value="">-- Seleccione un Departamento --</option>
      </select>
    </div>

    <div>
      <label for="activo">Activo:</label>
      <input type="checkbox" id="activo" th:field="*{activo}"/>
    </div>

    <div>
      <button type="submit">Guardar</button>
      <a th:href="@{/localidades}">Cancelar</a>
    </div>
  </form>

  <script>
    // JavaScript para filtrado en cascada
    document.addEventListener('DOMContentLoaded', function() {
      const paisSelect = document.getElementById('pais');
      const provinciaSelect = document.getElementById('provincia');
      const departamentoSelect = document.getElementById('departamento');

      // Función para limpiar un select
      function limpiarSelect(select, textoOpcionDefault) {
        select.innerHTML = '<option value="">' + textoOpcionDefault + '</option>';
        select.disabled = true;
      }

      // Función para habilitar un select
      function habilitarSelect(select) {
        select.disabled = false;
      }

      // Cuando cambia el país, cargar provincias
      paisSelect.addEventListener('change', function() {
        const paisId = this.value;

        // Limpiar selects dependientes
        limpiarSelect(provinciaSelect, '-- Seleccione una Provincia --');
        limpiarSelect(departamentoSelect, '-- Seleccione un Departamento --');

        if (paisId) {
          fetch('/provincias/api/por-pais/' + paisId)
            .then(response => response.json())
            .then(provincias => {
              provincias.forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia.id;
                option.text = provincia.nombre;
                provinciaSelect.appendChild(option);
              });
              habilitarSelect(provinciaSelect);
            })
            .catch(error => console.error('Error cargando provincias:', error));
        }
      });

      // Cuando cambia la provincia, cargar departamentos
      provinciaSelect.addEventListener('change', function() {
        const provinciaId = this.value;

        // Limpiar select dependiente
        limpiarSelect(departamentoSelect, '-- Seleccione un Departamento --');

        if (provinciaId) {
          fetch('/departamentos/api/por-provincia/' + provinciaId)
            .then(response => response.json())
            .then(departamentos => {
              departamentos.forEach(departamento => {
                const option = document.createElement('option');
                option.value = departamento.id;
                option.text = departamento.nombre;
                departamentoSelect.appendChild(option);
              });
              habilitarSelect(departamentoSelect);
            })
            .catch(error => console.error('Error cargando departamentos:', error));
        }
      });

      // Si estamos editando, cargar los datos existentes
      const paisActual = paisSelect.value;
      if (paisActual) {
        paisSelect.dispatchEvent(new Event('change'));
      }
    });
  </script>
</div>
</body>
</html>
