<!DOCTYPE html>
<html th:replace="~{fragments/layout :: layout(~{::title}, ~{::div})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Formulario Proveedor</title>
</head>
<body>
<div>
  <h2 th:text="${proveedor.id == null} ? 'Nuevo Proveedor' : 'Editar Proveedor'"></h2>
  <form method="post" th:action="@{/proveedores}" th:object="${proveedor}">
    <input th:field="*{id}" type="hidden"/>

    <div>
      <label for="cuit">CUIT:</label>
      <input id="cuit" required th:field="*{cuit}" type="text"/>
    </div>

    <div>
      <label for="nombre">Nombre:</label>
      <input id="nombre" required th:field="*{nombre}" type="text"/>
    </div>

    <div>
      <label for="apellido">Apellido:</label>
      <input id="apellido" required th:field="*{apellido}" type="text"/>
    </div>

    <div>
      <label for="email">Email:</label>
      <input id="email" required th:field="*{email}" type="email"/>
    </div>

    <h3>Dirección</h3>

    <div>
      <label for="calle">Calle:</label>
      <input id="calle" required th:field="*{direccion.calle}" type="text"/>
    </div>

    <div>
      <label for="altura">Altura:</label>
      <input id="altura" th:field="*{direccion.altura}" type="number"/>
    </div>

    <!-- Selección en cascada -->
    <div>
      <label for="pais">País:</label>
      <select id="pais" name="paisId" required>
        <option value="">-- Seleccione un País --</option>
        <option th:each="pais : ${paises}"
                th:selected="${proveedor.direccion != null && proveedor.direccion != null && proveedor.direccion.departamento != null && proveedor.direccion.departamento.provincia != null && proveedor.direccion.departamento.provincia.pais.id == pais.id}"
                th:text="${pais.nombre}"
                th:value="${pais.id}"></option>
      </select>
    </div>

    <div>
      <label for="provincia">Provincia:</label>
      <select disabled id="provincia" name="provinciaId" required>
        <option value="">-- Seleccione una Provincia --</option>
      </select>
    </div>

    <div>
      <label for="departamento">Departamento:</label>
      <select disabled id="departamento" name="departamentoId" required>
        <option value="">-- Seleccione un Departamento --</option>
      </select>
    </div>

    <div>
      <button type="submit">Guardar</button>
      <a th:href="@{/proveedores}">Cancelar</a>
    </div>
  </form>

  <script>
      // JavaScript para filtrado en cascada
      document.addEventListener('DOMContentLoaded', function () {
          const paisSelect = document.getElementById('pais');
          const provinciaSelect = document.getElementById('provincia');
          const departamentoSelect = document.getElementById('departamento');

          function limpiarSelect(select, textoOpcionDefault) {
              select.innerHTML = '<option value="">' + textoOpcionDefault + '</option>';
              select.disabled = true;
          }

          function habilitarSelect(select) {
              select.disabled = false;
          }

          function cargarOpciones(select, datos, valorSeleccionado = null) {
              select.innerHTML = '<option value="">-- Seleccione --</option>';
              datos.forEach(item => {
                  const option = document.createElement('option');
                  option.value = item.id;
                  option.text = item.nombre;
                  if (valorSeleccionado && item.id === valorSeleccionado) {
                      option.selected = true;
                  }
                  select.appendChild(option);
              });
              habilitarSelect(select);
          }

          // País → Provincias
          paisSelect.addEventListener('change', function () {
              const paisId = this.value;

              limpiarSelect(provinciaSelect, '-- Seleccione una Provincia --');
              limpiarSelect(departamentoSelect, '-- Seleccione un Departamento --');

              if (paisId) {
                  fetch('/provincias/api/por-pais/' + paisId)
                      .then(response => response.json())
                      .then(provincias => {
                          cargarOpciones(provinciaSelect, provincias);
                      })
                      .catch(error => console.error('Error cargando provincias:', error));
              }
          });

          // Provincia → Departamentos
          provinciaSelect.addEventListener('change', function () {
              const provinciaId = this.value;

              limpiarSelect(departamentoSelect, '-- Seleccione un Departamento --');

              if (provinciaId) {
                  fetch('/departamentos/api/por-provincia/' + provinciaId)
                      .then(response => response.json())
                      .then(departamentos => {
                          cargarOpciones(departamentoSelect, departamentos);
                      })
                      .catch(error => console.error('Error cargando departamentos:', error));
              }
          });

          // --- INICIO: Lógica para el modo de edición ---
          function inicializarCascada() {
              const paisId = paisSelect.value;
              if (!paisId) return; // No hacer nada si no hay país (modo nuevo)

              // IDs de la dirección existente (si los hay)
              const provinciaIdActual = "[[${proveedor.direccion?.departamento?.provincia?.id}]]";
              const departamentoIdActual = "[[${proveedor.direccion?.departamento?.id}]]";

              // 1. Cargar provincias y seleccionar la correcta
              fetch('/provincias/api/por-pais/' + paisId)
                  .then(response => response.json())
                  .then(provincias => {
                      cargarOpciones(provinciaSelect, provincias, provinciaIdActual);
                      // 2. Si hay provincia, cargar departamentos
                      if (provinciaIdActual) {
                          return fetch('/departamentos/api/por-provincia/' + provinciaIdActual);
                      }
                      return Promise.reject();
                  }).catch(error => {
                  if (error) console.error('Error en la inicialización de la cascada:', error);
              });
          }

          inicializarCascada();
          // --- FIN: Lógica para el modo de edición ---
      });
  </script>
</div>
</body>
</html>
