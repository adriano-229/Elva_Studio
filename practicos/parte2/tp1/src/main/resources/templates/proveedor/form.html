<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::div})}">
<head>
  <title>Formulario Proveedor</title>
</head>
<body>
<div>
  <h2 th:text="${proveedor.id == null} ? 'Nuevo Proveedor' : 'Editar Proveedor'"></h2>
  <form th:action="@{/proveedores}" th:object="${proveedor}" method="post">
    <input type="hidden" th:field="*{id}"/>

    <div>
      <label for="cuit">CUIT:</label>
      <input id="cuit" type="text" th:field="*{cuit}" required/>
    </div>

    <div>
      <label for="nombre">Nombre:</label>
      <input id="nombre" type="text" th:field="*{nombre}" required/>
    </div>

    <div>
      <label for="apellido">Apellido:</label>
      <input id="apellido" type="text" th:field="*{apellido}" required/>
    </div>

    <div>
      <label for="email">Email:</label>
      <input id="email" type="email" th:field="*{email}" required/>
    </div>

    <h3>Dirección</h3>

    <div>
      <label for="calle">Calle:</label>
      <input id="calle" type="text" th:field="*{direccion.calle}" required/>
    </div>

    <div>
      <label for="altura">Altura:</label>
      <input id="altura" type="number" th:field="*{direccion.altura}"/>
    </div>

    <!-- Selección en cascada para localidad: País → Provincia → Departamento → Localidad -->
    <div>
      <label for="pais">País:</label>
      <select id="pais" name="paisId" required>
        <option value="">-- Seleccione un País --</option>
        <option th:each="pais : ${paises}" th:value="${pais.id}" th:text="${pais.nombre}"
                th:selected="${proveedor.direccion != null && proveedor.direccion.localidad != null && proveedor.direccion.localidad.departamento != null && proveedor.direccion.localidad.departamento.provincia != null && proveedor.direccion.localidad.departamento.provincia.pais.id == pais.id}"></option>
      </select>
    </div>

    <div>
      <label for="provincia">Provincia:</label>
      <select id="provincia" name="provinciaId" required disabled>
        <option value="">-- Seleccione una Provincia --</option>
      </select>
    </div>

    <div>
      <label for="departamento">Departamento:</label>
      <select id="departamento" name="departamentoId" required disabled>
        <option value="">-- Seleccione un Departamento --</option>
      </select>
    </div>

    <div>
      <label for="localidad">Localidad:</label>
      <select id="localidad" th:field="*{direccion.localidad.id}" required disabled>
        <option value="">-- Seleccione una Localidad --</option>
      </select>
    </div>

    <div>
      <label for="activo">Activo:</label>
      <input type="checkbox" id="activo" th:field="*{activo}"/>
    </div>

    <div>
      <button type="submit">Guardar</button>
      <a th:href="@{/proveedores}">Cancelar</a>
    </div>
  </form>

  <script>
    // JavaScript para filtrado en cascada para localidad
    document.addEventListener('DOMContentLoaded', function() {
      const paisSelect = document.getElementById('pais');
      const provinciaSelect = document.getElementById('provincia');
      const departamentoSelect = document.getElementById('departamento');
      const localidadSelect = document.getElementById('localidad');

      function limpiarSelect(select, textoOpcionDefault) {
        select.innerHTML = '<option value="">' + textoOpcionDefault + '</option>';
        select.disabled = true;
      }

      function habilitarSelect(select) {
        select.disabled = false;
      }

      function cargarOpciones(select, datos, valorSeleccionado = null) {
        select.innerHTML = '<option value="">-- Seleccione --</option>';
        datos.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.text = item.nombre;
          if (valorSeleccionado && item.id == valorSeleccionado) {
            option.selected = true;
          }
          select.appendChild(option);
        });
        habilitarSelect(select);
      }

      // País → Provincias
      paisSelect.addEventListener('change', function() {
        const paisId = this.value;

        limpiarSelect(provinciaSelect, '-- Seleccione una Provincia --');
        limpiarSelect(departamentoSelect, '-- Seleccione un Departamento --');
        limpiarSelect(localidadSelect, '-- Seleccione una Localidad --');

        if (paisId) {
          fetch('/provincias/api/por-pais/' + paisId)
            .then(response => response.json())
            .then(provincias => {
              cargarOpciones(provinciaSelect, provincias);
            })
            .catch(error => console.error('Error cargando provincias:', error));
        }
      });

      // Provincia → Departamentos
      provinciaSelect.addEventListener('change', function() {
        const provinciaId = this.value;

        limpiarSelect(departamentoSelect, '-- Seleccione un Departamento --');
        limpiarSelect(localidadSelect, '-- Seleccione una Localidad --');

        if (provinciaId) {
          fetch('/departamentos/api/por-provincia/' + provinciaId)
            .then(response => response.json())
            .then(departamentos => {
              cargarOpciones(departamentoSelect, departamentos);
            })
            .catch(error => console.error('Error cargando departamentos:', error));
        }
      });

      // Departamento → Localidades
      departamentoSelect.addEventListener('change', function() {
        const departamentoId = this.value;

        limpiarSelect(localidadSelect, '-- Seleccione una Localidad --');

        if (departamentoId) {
          fetch('/localidades/api/por-departamento/' + departamentoId)
            .then(response => response.json())
            .then(localidades => {
              cargarOpciones(localidadSelect, localidades);
            })
            .catch(error => console.error('Error cargando localidades:', error));
        }
      });

      // Precargar datos si estamos editando
      /*[# th:if="${provinciasActuales != null}" ]*/
        cargarOpciones(provinciaSelect, /*[[${provinciasActuales}]]*/ []);

        /*[# th:if="${departamentosActuales != null}" ]*/
          cargarOpciones(departamentoSelect, /*[[${departamentosActuales}]]*/ []);

          /*[# th:if="${localidadesActuales != null}" ]*/
            cargarOpciones(localidadSelect, /*[[${localidadesActuales}]]*/ []);
          /*[/]*/
        /*[/]*/
      /*[/]*/
    });
  </script>
</div>
</body>
</html>
