<!DOCTYPE html>
<html th:replace="~{fragments/layout :: layout(~{::title}, ~{::div})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Formulario Departamento</title>
</head>
<body>
<div>
  <h2 th:text="${departamento.id == null} ? 'Nuevo Departamento' : 'Editar Departamento'"></h2>
  <form method="post" th:action="@{/departamentos}" th:object="${departamento}">
    <input th:field="*{id}" type="hidden"/>

    <div>
      <label for="nombre">Nombre:</label>
      <input id="nombre" required th:field="*{nombre}" type="text"/>
    </div>

    <div>
      <label for="pais">País:</label>
      <select id="pais" name="paisId" required>
        <option value="">-- Seleccione un País --</option>
        <option th:each="pais : ${paises}"
                th:selected="${departamento.provincia != null and departamento.provincia.pais.id == pais.id}"
                th:text="${pais.nombre}"
                th:value="${pais.id}"></option>
      </select>
    </div>

    <div>
      <label for="provincia">Provincia:</label>
      <input type="hidden" id="provinciaActualId" th:value="${departamento.provincia != null ? departamento.provincia.id : ''}">
      <select disabled id="provincia" required th:field="*{provincia.id}">
        <option value="">-- Seleccione una Provincia --</option>
      </select>
    </div>

    <div>
      <button type="submit">Guardar</button>
      <a th:href="@{/departamentos}">Cancelar</a>
    </div>
  </form>

  <script>
      document.addEventListener('DOMContentLoaded', function () {
          const paisSelect = document.getElementById('pais');
          const provinciaSelect = document.getElementById('provincia');
          const provinciaActualId = document.getElementById('provinciaActualId').value;

          function limpiarSelect(select, textoOpcionDefault) {
              select.innerHTML = '<option value="">' + textoOpcionDefault + '</option>';
              select.disabled = true;
          }

          function habilitarSelect(select) {
              select.disabled = false;
          }

          paisSelect.addEventListener('change', function () {
              const paisId = this.value;
              limpiarSelect(provinciaSelect, '-- Seleccione una Provincia --');
              if (paisId) {
                  fetch('/provincias/api/por-pais/' + paisId)
                      .then(response => response.json())
                      .then(provincias => {
                          provincias.forEach(provincia => {
                              const option = document.createElement('option');
                              option.value = provincia.id;
                              option.text = provincia.nombre;
                              if (provinciaActualId && String(provincia.id) === String(provinciaActualId)) {
                                  option.selected = true;
                              }
                              provinciaSelect.appendChild(option);
                          });
                          if (provincias.length > 0) habilitarSelect(provinciaSelect);
                      })
                      .catch(error => console.error('Error cargando provincias:', error));
              }
          });

          if (paisSelect.value) {
              paisSelect.dispatchEvent(new Event('change'));
          }
      });
  </script>
</div>
</body>
</html>
