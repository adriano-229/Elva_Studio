<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::div})}">
<head>
  <title>Formulario Departamento</title>
</head>
<body>
<div>
  <h2 th:text="${departamento.id == null} ? 'Nuevo Departamento' : 'Editar Departamento'"></h2>
  <form th:action="@{/departamentos}" th:object="${departamento}" method="post">
    <input type="hidden" th:field="*{id}"/>

    <div>
      <label for="nombre">Nombre:</label>
      <input id="nombre" type="text" th:field="*{nombre}" required/>
    </div>

    <!-- Selección en cascada: País → Provincia → Departamento -->
    <div>
      <label for="pais">País:</label>
      <select id="pais" name="paisId" required>
        <option value="">-- Seleccione un País --</option>
        <option th:each="pais : ${paises}" th:value="${pais.id}" th:text="${pais.nombre}"
                th:selected="${departamento.provincia != null && departamento.provincia.pais.id == pais.id}"></option>
      </select>
    </div>

    <div>
      <label for="provincia">Provincia:</label>
      <select id="provincia" th:field="*{provincia.id}" required disabled>
        <option value="">-- Seleccione una Provincia --</option>
      </select>
    </div>

    <div>
      <label for="activo">Activo:</label>
      <input type="checkbox" id="activo" th:field="*{activo}"/>
    </div>

    <div>
      <button type="submit">Guardar</button>
      <a th:href="@{/departamentos}">Cancelar</a>
    </div>
  </form>

  <script>
    // JavaScript para filtrado en cascada: País → Provincia
    document.addEventListener('DOMContentLoaded', function() {
      const paisSelect = document.getElementById('pais');
      const provinciaSelect = document.getElementById('provincia');

      function limpiarSelect(select, textoOpcionDefault) {
        select.innerHTML = '<option value="">' + textoOpcionDefault + '</option>';
        select.disabled = true;
      }

      function habilitarSelect(select) {
        select.disabled = false;
      }

      // País → Provincias
      paisSelect.addEventListener('change', function() {
        const paisId = this.value;

        limpiarSelect(provinciaSelect, '-- Seleccione una Provincia --');

        if (paisId) {
          fetch('/provincias/api/por-pais/' + paisId)
            .then(response => response.json())
            .then(provincias => {
              provincias.forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia.id;
                option.text = provincia.nombre;
                provinciaSelect.appendChild(option);
              });
              habilitarSelect(provinciaSelect);
            })
            .catch(error => console.error('Error cargando provincias:', error));
        }
      });

      // Si estamos editando, cargar los datos existentes
      const paisActual = paisSelect.value;
      if (paisActual) {
        paisSelect.dispatchEvent(new Event('change'));
      }
    });
  </script>
</div>
</body>
</html>
