<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::div})}">
<head>
  <title>Formulario Empresa</title>
</head>
<body>
<div>
  <h2 th:text="${empresa.id == null} ? 'Nueva Empresa' : 'Editar Empresa'"></h2>
  <form th:action="@{/empresas}" th:object="${empresa}" method="post">
    <input type="hidden" th:field="*{id}"/>

    <div>
      <label for="razonSocial">Razón Social:</label>
      <input id="razonSocial" type="text" th:field="*{razonSocial}" required/>
    </div>

    <h3>Dirección</h3>

    <div>
      <label for="calle">Calle:</label>
      <input id="calle" type="text" th:field="*{direccion.calle}" required/>
    </div>

    <div>
      <label for="altura">Altura:</label>
      <input id="altura" type="number" th:field="*{direccion.altura}"/>
    </div>

    <!-- Selección en cascada para localidad: País → Provincia → Departamento → Localidad -->
    <div>
      <label for="pais">País:</label>
      <select id="pais" name="paisId" required>
        <option value="">-- Seleccione un País --</option>
        <option th:each="pais : ${paises}" th:value="${pais.id}" th:text="${pais.nombre}"
                th:selected="${empresa.direccion != null && empresa.direccion.localidad != null && empresa.direccion.localidad.departamento != null && empresa.direccion.localidad.departamento.provincia != null && empresa.direccion.localidad.departamento.provincia.pais.id == pais.id}"></option>
      </select>
    </div>

    <div>
      <label for="provincia">Provincia:</label>
      <select id="provincia" name="provinciaId" required disabled>
        <option value="">-- Seleccione una Provincia --</option>
      </select>
    </div>

    <div>
      <label for="departamento">Departamento:</label>
      <select id="departamento" name="departamentoId" required disabled>
        <option value="">-- Seleccione un Departamento --</option>
      </select>
    </div>

    <div>
      <label for="localidad">Localidad:</label>
      <select id="localidad" th:field="*{direccion.localidad.id}" required disabled>
        <option value="">-- Seleccione una Localidad --</option>
      </select>
    </div>

    <div>
      <label for="activo">Activo:</label>
      <input type="checkbox" id="activo" th:field="*{activo}"/>
    </div>

    <div>
      <button type="submit">Guardar</button>
      <a th:href="@{/empresas}">Cancelar</a>
    </div>
  </form>

  <script>
    // JavaScript para filtrado en cascada hasta Localidad
    document.addEventListener('DOMContentLoaded', function() {
      const paisSelect = document.getElementById('pais');
      const provinciaSelect = document.getElementById('provincia');
      const departamentoSelect = document.getElementById('departamento');
      const localidadSelect = document.getElementById('localidad');

      function limpiarSelect(select, textoOpcionDefault) {
        select.innerHTML = '<option value="">' + textoOpcionDefault + '</option>';
        select.disabled = true;
      }

      function habilitarSelect(select) {
        select.disabled = false;
      }

      function cargarOpciones(select, datos, valorSeleccionado = null) {
        select.innerHTML = '<option value="">-- Seleccione --</option>';
        datos.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.text = item.nombre;
          if (valorSeleccionado && item.id == valorSeleccionado) {
            option.selected = true;
          }
          select.appendChild(option);
        });
        habilitarSelect(select);
      }

      // País → Provincias
      paisSelect.addEventListener('change', function() {
        const paisId = this.value;

        limpiarSelect(provinciaSelect, '-- Seleccione una Provincia --');
        limpiarSelect(departamentoSelect, '-- Seleccione un Departamento --');
        limpiarSelect(localidadSelect, '-- Seleccione una Localidad --');

        if (paisId) {
          fetch('/provincias/api/por-pais/' + paisId)
            .then(response => response.json())
            .then(provincias => {
              cargarOpciones(provinciaSelect, provincias);
            })
            .catch(error => console.error('Error cargando provincias:', error));
        }
      });

      // Provincia → Departamentos
      provinciaSelect.addEventListener('change', function() {
        const provinciaId = this.value;

        limpiarSelect(departamentoSelect, '-- Seleccione un Departamento --');
        limpiarSelect(localidadSelect, '-- Seleccione una Localidad --');

        if (provinciaId) {
          fetch('/departamentos/api/por-provincia/' + provinciaId)
            .then(response => response.json())
            .then(departamentos => {
              cargarOpciones(departamentoSelect, departamentos);
            })
            .catch(error => console.error('Error cargando departamentos:', error));
        }
      });

      // Departamento → Localidades
      departamentoSelect.addEventListener('change', function() {
        const departamentoId = this.value;

        limpiarSelect(localidadSelect, '-- Seleccione una Localidad --');

        if (departamentoId) {
          fetch('/localidades/api/por-departamento/' + departamentoId)
            .then(response => response.json())
            .then(localidades => {
              cargarOpciones(localidadSelect, localidades);
            })
            .catch(error => console.error('Error cargando localidades:', error));
        }
      });

      // --- INICIO: Lógica para el modo de edición ---
      function inicializarCascada() {
        const paisId = paisSelect.value;
        if (!paisId) return; // No hacer nada si no hay país (modo nuevo)

        // IDs de la dirección existente (si los hay)
        const provinciaIdActual = "[[${empresa.direccion?.localidad?.departamento?.provincia?.id}]]";
        const departamentoIdActual = "[[${empresa.direccion?.localidad?.departamento?.id}]]";
        const localidadIdActual = "[[${empresa.direccion?.localidad?.id}]]";

        // 1. Cargar provincias y seleccionar la correcta
        fetch('/provincias/api/por-pais/' + paisId)
          .then(response => response.json())
          .then(provincias => {
            cargarOpciones(provinciaSelect, provincias, provinciaIdActual);
            // 2. Si hay provincia, cargar departamentos
            if (provinciaIdActual) {
              return fetch('/departamentos/api/por-provincia/' + provinciaIdActual);
            }
            return Promise.reject();
          })
          .then(response => response.json())
          .then(departamentos => {
            cargarOpciones(departamentoSelect, departamentos, departamentoIdActual);
            // 3. Si hay departamento, cargar localidades
            if (departamentoIdActual) {
              return fetch('/localidades/api/por-departamento/' + departamentoIdActual);
            }
            return Promise.reject();
          })
          .then(response => response.json())
          .then(localidades => {
            cargarOpciones(localidadSelect, localidades, localidadIdActual);
          })
          .catch(error => {
            if (error) console.error('Error en la inicialización de la cascada:', error);
          });
      }

      inicializarCascada();
      // --- FIN: Lógica para el modo de edición ---
    });
  </script>
</div>
</body>
</html>