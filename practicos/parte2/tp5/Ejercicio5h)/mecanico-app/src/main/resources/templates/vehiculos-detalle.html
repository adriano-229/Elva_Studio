<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout('Detalle de vehículo', ~{::section})}">
<section>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0" th:text="${vehiculo.marca + ' ' + vehiculo.modelo}">Vehículo</h1>
            <p class="text-muted mb-0">
                Patente <strong th:text="${vehiculo.patente}">AA123BB</strong> · Cliente
                <strong th:text="${vehiculo.cliente.nombre + ' ' + vehiculo.cliente.apellido}">Juan Pérez</strong>
            </p>
        </div>
        <a class="btn btn-outline-secondary" th:href="@{/}">Volver</a>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">Registrar reparación</h2>
                </div>
                <div class="card-body">
                    <form th:action="@{/reparaciones}" th:object="${reparacionForm}" method="post" novalidate>
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" th:field="*{vehiculoId}">
                        <div th:if="${alertaMecanico}" class="alert alert-warning" role="alert"
                             th:text="${alertaMecanico}">
                            No hay mecánico vinculado.
                        </div>
                        <div class="mb-3">
                            <label for="tipoReparacion" class="form-label">Tipo de reparación</label>
                            <select id="tipoReparacion" class="form-select" th:field="*{tipoReparacion}"
                                    th:classappend="${#fields.hasErrors('tipoReparacion')}? 'is-invalid'">
                                <option value="" disabled th:selected="${reparacionForm.tipoReparacion == null}">
                                    Seleccione una opción
                                </option>
                                <option th:each="tipo : ${tiposReparacion}"
                                        th:value="${tipo}" th:text="${#strings.capitalize(tipo.name().toLowerCase())}">
                                    Tipo
                                </option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('tipoReparacion')}"
                                 th:errors="*{tipoReparacion}">Seleccione el tipo</div>
                        </div>
                        <div class="mb-3" th:if="${!esMecanico}">
                            <label for="mecanicoId" class="form-label">Mecánico</label>
                            <select id="mecanicoId" class="form-select" th:field="*{mecanicoId}"
                                    th:classappend="${#fields.hasErrors('mecanicoId')}? 'is-invalid'">
                                <option value="" disabled th:selected="${reparacionForm.mecanicoId == null}">
                                    Seleccione un mecánico
                                </option>
                                <option th:each="mecanico : ${mecanicos}"
                                        th:value="${mecanico.id}"
                                        th:text="${mecanico.nombre + ' ' + mecanico.apellido + ' (' + mecanico.legajo + ')'}">
                                    Mecánico
                                </option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('mecanicoId')}"
                                 th:errors="*{mecanicoId}">Seleccione un mecánico</div>
                        </div>
                        <div class="mb-3" th:if="${esMecanico}">
                            <label class="form-label">Mecánico asignado</label>
                            <input type="text" class="form-control" th:value="${mecanicoActual != null ? mecanicoActual.nombre + ' ' + mecanicoActual.apellido + ' (' + mecanicoActual.legajo + ')' : 'Sin mecánico asociado'}" readonly>
                            <input type="hidden" th:field="*{mecanicoId}">
                            <div class="form-text text-danger" th:if="${mecanicoActual == null}">
                                Comuníquese con un administrador para vincular su usuario a un mecánico.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción del trabajo</label>
                            <textarea id="descripcion" class="form-control" rows="3" th:field="*{descripcion}"
                                      placeholder="Observaciones y tareas realizadas"
                                      th:classappend="${#fields.hasErrors('descripcion')}? 'is-invalid'"></textarea>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('descripcion')}"
                                 th:errors="*{descripcion}">Ingrese un detalle</div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Registrar reparación</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">Historial de arreglos</h2>
                </div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(historial)}" class="text-muted text-center py-4">
                        Aún no se registraron reparaciones para este vehículo.
                    </div>
                    <div th:if="${!#lists.isEmpty(historial)}" class="timeline">
                        <div th:each="item : ${historial}" class="border-start ps-3 mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-primary" th:text="${item.tipoReparacion}">MOTOR</span>
                                <small class="text-muted"
                                       th:text="${#temporals.format(item.fechaArreglo, 'dd/MM/yyyy HH:mm')}">
                                    21/05/2024 10:00
                                </small>
                            </div>
                            <p class="mt-2 mb-1" th:text="${item.detalleArreglo}">Detalle</p>
                            <small class="text-muted"
                                   th:text="${'Mecánico: ' + item.mecanico.nombre + ' ' + item.mecanico.apellido}">
                                Mecánico
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
</html>
