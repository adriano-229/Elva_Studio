<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>Book Form - Library System</title>
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <style>
    .selection-container {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      background-color: #f8f9fa;
      margin-bottom: 20px;
    }

    .entity-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background-color: white;
      padding: 10px;
    }

    .entity-item {
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .entity-item:hover {
      background-color: #e9ecef;
    }

    .entity-item.selected {
      background-color: #0d6efd;
      color: white;
      border-color: #0a58ca;
    }

    .entity-item input[type="checkbox"] {
      margin-right: 8px;
    }

    .search-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .sort-buttons {
      display: flex;
      gap: 5px;
    }

    .selected-count {
      font-weight: bold;
      color: #0d6efd;
    }
  </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="/">
      <i class="bi bi-book me-2"></i>Library System
    </a>
    <div class="ms-auto">
      <a class="btn btn-light btn-sm" href="/books">
        <i class="bi bi-arrow-left me-1"></i>Back to Books
      </a>
    </div>
  </div>
</nav>

<div class="content-wrapper">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1>
        <i class="bi bi-book-fill me-2"></i>
        Create New Book
      </h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item"><a href="/books">Books</a></li>
          <li class="breadcrumb-item active">Create</li>
        </ol>
      </nav>
    </div>

    <!-- Form -->
    <div class="form-container">
      <form class="needs-validation" enctype="multipart/form-data" method="post" novalidate
            th:action="@{/books/createFacade}" th:object="${bookDTO}" id="bookForm">

        <div class="row">
          <!-- Title -->
          <div class="col-md-6 mb-3">
            <label class="form-label" for="title">
              <i class="bi bi-bookmark me-1"></i>Title *
            </label>
            <input class="form-control" id="title" placeholder="Enter book title" required th:field="*{title}"
                   type="text"/>
            <div class="invalid-feedback">
              Please enter a book title.
            </div>
          </div>

          <!-- ISBN -->
          <div class="col-md-6 mb-3">
            <label class="form-label" for="isbn">
              <i class="bi bi-upc me-1"></i>ISBN *
            </label>
            <input class="form-control" id="isbn" placeholder="Enter ISBN" required th:field="*{isbn}" type="text"/>
            <div class="invalid-feedback">
              Please enter an ISBN.
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Total Copies -->
          <div class="col-md-6 mb-3">
            <label class="form-label" for="totalCopies">
              <i class="bi bi-stack me-1"></i>Total Copies *
            </label>
            <input class="form-control" id="totalCopies" min="0" placeholder="0" required th:field="*{totalCopies}"
                   type="number"/>
            <div class="invalid-feedback">
              Please enter the total number of copies.
            </div>
          </div>

          <!-- Publication Year -->
          <div class="col-md-6 mb-3">
            <label class="form-label" for="publicationYear">
              <i class="bi bi-calendar me-1"></i>Publication Year
            </label>
            <input class="form-control" id="publicationYear" min="1000" max="2100" placeholder="YYYY"
                   th:field="*{publicationYear}" type="number"/>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12 mb-3">
            <label class="form-label" for="imageFile">
              <i class="bi bi-image me-1"></i>Cover Image
            </label>
            <input accept="image/*" class="form-control" id="imageFile" name="imageFile" type="file"/>
            <small class="form-text text-muted">Optional. Upload a cover image for the book.</small>
          </div>
        </div>

        <!-- Authors Selection -->
        <div class="selection-container">
          <h4><i class="bi bi-person-fill me-2"></i>Authors *</h4>
          <p class="text-muted">Select at least one author for this book. Selected: <span class="selected-count" id="authorCount">0</span></p>

          <div class="search-controls">
            <input type="text" class="form-control" id="authorSearch" placeholder="Search authors by name...">
            <div class="sort-buttons">
              <button type="button" class="btn btn-outline-secondary" onclick="sortAuthors('asc')">
                <i class="bi bi-sort-alpha-down"></i> A-Z
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="sortAuthors('desc')">
                <i class="bi bi-sort-alpha-up"></i> Z-A
              </button>
            </div>
            <button type="button" class="btn btn-outline-primary" onclick="clearAuthorSelection()">
              <i class="bi bi-x-circle me-1"></i> Clear Selection
            </button>
            <a class="btn btn-success" href="/authors/create" target="_blank">
              <i class="bi bi-plus-circle me-1"></i> New Author
            </a>
          </div>

          <div class="entity-list" id="authorList">
            <div class="entity-item" th:each="author : ${authors}"
                 th:data-id="${author.id}"
                 th:data-name="${author.name}"
                 onclick="toggleAuthorSelection(this)">
              <input type="checkbox" th:id="'author-' + ${author.id}" th:value="${author.id}" onclick="event.stopPropagation()">
              <label th:for="'author-' + ${author.id}" th:text="${author.name}" style="cursor: pointer; margin: 0;"></label>
            </div>
          </div>

          <!-- Hidden field to store selected author IDs -->
          <input type="hidden" id="authorIdsField" name="authorIds">
        </div>

        <!-- Publishers Selection -->
        <div class="selection-container">
          <h4><i class="bi bi-building me-2"></i>Publishers *</h4>
          <p class="text-muted">Select at least one publisher for this book. Selected: <span class="selected-count" id="publisherCount">0</span></p>

          <div class="search-controls">
            <input type="text" class="form-control" id="publisherSearch" placeholder="Search publishers by name...">
            <div class="sort-buttons">
              <button type="button" class="btn btn-outline-secondary" onclick="sortPublishers('asc')">
                <i class="bi bi-sort-alpha-down"></i> A-Z
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="sortPublishers('desc')">
                <i class="bi bi-sort-alpha-up"></i> Z-A
              </button>
            </div>
            <button type="button" class="btn btn-outline-primary" onclick="clearPublisherSelection()">
              <i class="bi bi-x-circle me-1"></i> Clear Selection
            </button>
            <a class="btn btn-success" href="/publishers/create" target="_blank">
              <i class="bi bi-plus-circle me-1"></i> New Publisher
            </a>
          </div>

          <div class="entity-list" id="publisherList">
            <div class="entity-item" th:each="publisher : ${publishers}"
                 th:data-id="${publisher.id}"
                 th:data-name="${publisher.name}"
                 onclick="togglePublisherSelection(this)">
              <input type="checkbox" th:id="'publisher-' + ${publisher.id}" th:value="${publisher.id}" onclick="event.stopPropagation()">
              <label th:for="'publisher-' + ${publisher.id}" th:text="${publisher.name}" style="cursor: pointer; margin: 0;"></label>
            </div>
          </div>

          <!-- Hidden field to store selected publisher IDs -->
          <input type="hidden" id="publisherIdsField" name="publisherIds">
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 mt-4">
          <button class="btn btn-primary btn-lg" type="submit">
            <i class="bi bi-save me-2"></i>Save Book
          </button>
          <a class="btn btn-secondary btn-lg" href="/books">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script crossorigin="anonymous"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Author selection management
    let selectedAuthors = new Set();
    let selectedPublishers = new Set();

    function toggleAuthorSelection(element) {
        const checkbox = element.querySelector('input[type="checkbox"]');
        const authorId = element.dataset.id;

        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
            selectedAuthors.add(authorId);
            element.classList.add('selected');
        } else {
            selectedAuthors.delete(authorId);
            element.classList.remove('selected');
        }

        updateAuthorField();
        updateAuthorCount();
    }

    function togglePublisherSelection(element) {
        const checkbox = element.querySelector('input[type="checkbox"]');
        const publisherId = element.dataset.id;

        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
            selectedPublishers.add(publisherId);
            element.classList.add('selected');
        } else {
            selectedPublishers.delete(publisherId);
            element.classList.remove('selected');
        }

        updatePublisherField();
        updatePublisherCount();
    }

    function updateAuthorField() {
        document.getElementById('authorIdsField').value = Array.from(selectedAuthors).join(',');
    }

    function updatePublisherField() {
        document.getElementById('publisherIdsField').value = Array.from(selectedPublishers).join(',');
    }

    function updateAuthorCount() {
        document.getElementById('authorCount').textContent = selectedAuthors.size;
    }

    function updatePublisherCount() {
        document.getElementById('publisherCount').textContent = selectedPublishers.size;
    }

    function clearAuthorSelection() {
        selectedAuthors.clear();
        document.querySelectorAll('#authorList .entity-item').forEach(item => {
            item.classList.remove('selected');
            item.querySelector('input[type="checkbox"]').checked = false;
        });
        updateAuthorField();
        updateAuthorCount();
    }

    function clearPublisherSelection() {
        selectedPublishers.clear();
        document.querySelectorAll('#publisherList .entity-item').forEach(item => {
            item.classList.remove('selected');
            item.querySelector('input[type="checkbox"]').checked = false;
        });
        updatePublisherField();
        updatePublisherCount();
    }

    // Search functionality
    document.getElementById('authorSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('#authorList .entity-item').forEach(item => {
            const name = item.dataset.name.toLowerCase();
            item.style.display = name.includes(searchTerm) ? 'block' : 'none';
        });
    });

    document.getElementById('publisherSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('#publisherList .entity-item').forEach(item => {
            const name = item.dataset.name.toLowerCase();
            item.style.display = name.includes(searchTerm) ? 'block' : 'none';
        });
    });

    // Sorting functionality
    function sortAuthors(order) {
        const list = document.getElementById('authorList');
        const items = Array.from(list.querySelectorAll('.entity-item'));

        items.sort((a, b) => {
            const nameA = a.dataset.name.toLowerCase();
            const nameB = b.dataset.name.toLowerCase();
            return order === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
        });

        items.forEach(item => list.appendChild(item));
    }

    function sortPublishers(order) {
        const list = document.getElementById('publisherList');
        const items = Array.from(list.querySelectorAll('.entity-item'));

        items.sort((a, b) => {
            const nameA = a.dataset.name.toLowerCase();
            const nameB = b.dataset.name.toLowerCase();
            return order === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
        });

        items.forEach(item => list.appendChild(item));
    }

    // Form validation
    document.getElementById('bookForm').addEventListener('submit', function(event) {
        const form = this;

        // Check if at least one author is selected
        if (selectedAuthors.size === 0) {
            event.preventDefault();
            event.stopPropagation();
            alert('Please select at least one author.');
            return false;
        }

        // Check if at least one publisher is selected
        if (selectedPublishers.size === 0) {
            event.preventDefault();
            event.stopPropagation();
            alert('Please select at least one publisher.');
            return false;
        }

        // Standard form validation
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }

        form.classList.add('was-validated');
    });

    // Initialize counts on page load
    updateAuthorCount();
    updatePublisherCount();
</script>
</body>
</html>
