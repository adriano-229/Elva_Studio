<!-- src/main/resources/templates/direccion/form.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><meta charset="UTF-8"><title>Dirección</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"></head>
<body class="container py-4">
  <h1 class="h4 mb-3">Dirección</h1>

  <form th:action="${#strings.isEmpty(form.id)} ? @{/admin/direcciones} : @{|/admin/direcciones/${form.id}|}"
        method="post" th:object="${form}">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Calle</label>
        <input class="form-control" th:field="*{calle}">
        <div class="text-danger" th:if="${#fields.hasErrors('calle')}" th:errors="*{calle}"></div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Numeración</label>
        <input class="form-control" th:field="*{numeracion}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Barrio</label>
        <input class="form-control" th:field="*{barrio}">
      </div>

      <!-- Cascada País -> Provincia -> Departamento -> Localidad -->
      <div class="col-md-3">
        <label class="form-label">País</label>
        <select id="pais" class="form-select">
          <option value="">-- Seleccionar --</option>
          <option th:each="p : ${paises}" th:value="${p.id}" th:text="${p.nombre}"></option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Provincia</label>
        <select id="provincia" class="form-select"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Departamento</label>
        <select id="departamento" class="form-select"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Localidad</label>
        <select id="localidad" class="form-select" th:field="*{localidadId}"></select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Manzana/Piso</label>
        <input class="form-control" th:field="*{manzanaPiso}">
      </div>
      <div class="col-md-6">
        <label class="form-label">Casa/Departamento</label>
        <input class="form-control" th:field="*{casaDepartamento}">
      </div>
      <div class="col-12">
        <label class="form-label">Referencia</label>
        <textarea class="form-control" th:field="*{referencia}"></textarea>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Guardar</button>
      <a class="btn btn-secondary" th:href="@{/admin/direcciones}">Volver</a>
    </div>
  </form>

<script>
async function load(url, params) {
  const qs = new URLSearchParams(params).toString();
  const res = await fetch(url + (qs ? `?${qs}` : ''));
  return res.json();
}
function fillSelect(sel, items, placeholder='-- Seleccionar --') {
  sel.innerHTML = `<option value="">${placeholder}</option>`;
  items.forEach(i => sel.insertAdjacentHTML('beforeend', `<option value="${i.id}">${i.nombre}</option>`));
}

const $pais = document.getElementById('pais');
const $provincia = document.getElementById('provincia');
const $departamento = document.getElementById('departamento');
const $localidad = document.getElementById('localidad');

$pais.addEventListener('change', async () => {
  fillSelect($provincia, []);
  fillSelect($departamento, []);
  fillSelect($localidad, []);
  if ($pais.value) {
    const data = await load('/api/ubicacion/provincias', {paisId: $pais.value});
    fillSelect($provincia, data);
  }
});
$provincia.addEventListener('change', async () => {
  fillSelect($departamento, []);
  fillSelect($localidad, []);
  if ($provincia.value) {
    const data = await load('/api/ubicacion/departamentos', {provinciaId: $provincia.value});
    fillSelect($departamento, data);
  }
});
$departamento.addEventListener('change', async () => {
  fillSelect($localidad, []);
  if ($departamento.value) {
    const data = await load('/api/ubicacion/localidades', {departamentoId: $departamento.value});
    fillSelect($localidad, data);
  }
});
</script>
</body>
</html>
