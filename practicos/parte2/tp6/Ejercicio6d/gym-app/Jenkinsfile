pipeline {
  agent any
  options { timestamps(); ansiColor('xterm') }

  environment {
    SUBDIR = 'practicos/parte2/tp6/Ejercicio6d/gym-app'
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build image & start DB') {
      steps {
        dir("${SUBDIR}") {
          sh '''
            set -e
            docker compose down || true
            docker compose build

            # Levantar solo MySQL y esperar HEALTHY
            docker compose up -d mysql
            echo "Esperando a que MySQL quede healthy..."
            MYSQL_CID="$(docker compose ps -q mysql || true)"
            [ -n "$MYSQL_CID" ] || { echo "No se encontró el contenedor mysql"; exit 1; }

            for i in $(seq 1 60); do
              STATUS="$(docker inspect -f '{{.State.Health.Status}}' "$MYSQL_CID" 2>/dev/null || echo missing)"
              [ "$STATUS" = healthy ] && { echo "MySQL healthy ✅"; break; }
              echo "MySQL status: $STATUS (intento $i/60)"
              sleep 3
            done

            STATUS="$(docker inspect -f '{{.State.Health.Status}}' "$MYSQL_CID" 2>/dev/null || echo missing)"
            [ "$STATUS" = healthy ] || { echo "MySQL no llegó a healthy ❌"; docker compose logs mysql || true; exit 1; }
          '''
        }
      }
    }

    stage('Start app') {
      steps {
        dir("${SUBDIR}") {
          sh '''
            set -e
            docker compose up -d app
            docker compose ps
          '''
        }
      }
    }

    stage('Healthcheck app') {
      steps {
        dir("${SUBDIR}") {
          sh '''
            set -e
            HOST_IP=$(ip -4 route list default | awk \'{print $3}\')
            APP_URL="http://${HOST_IP}:9000/actuator/health"
            echo "Chequeando app en: $APP_URL"

            for i in $(seq 1 60); do
              if curl -fsS "$APP_URL" >/dev/null 2>&1; then
                echo "App UP ✅"
                exit 0
              fi
              echo "Esperando app... ($i/60)"
              sleep 3
            done

            echo "Healthcheck de la app FALLÓ ❌"
            docker compose logs app || true
            exit 1
          '''
        }
      }
    }
  }

  post {
    always {
      dir("${SUBDIR}") {
        sh '''
          docker compose logs --no-color > compose.logs || true
          docker compose logs mysql --no-color > mysql.logs || true
          docker compose logs app --no-color > app.logs || true
        '''
      }
      archiveArtifacts artifacts: '*/**/*.logs, *.logs, **/*.logs', allowEmptyArchive: true
    }
    success { echo '✅ Deploy OK' }
    failure { echo '❌ Deploy fallido' }
  }
}