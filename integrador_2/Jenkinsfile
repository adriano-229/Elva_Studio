pipeline {
    agent any

    options {
        timestamps()
        ansiColor('xterm')
    }

    environment {
        SUBDIR = 'integrador_2'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    if (fileExists("${env.SUBDIR}/docker-compose.yml")) {
                        env.TARGET_DIR = env.SUBDIR
                    } else if (fileExists('docker-compose.yml')) {
                        env.TARGET_DIR = '.'
                    } else {
                        error("No encontré docker-compose.yml ni en la raíz ni en ${env.SUBDIR}")
                    }
                }
            }
        }

        stage('Build images & start DB') {
            steps {
                dir("${env.TARGET_DIR}") {
                    sh '''
                        set -e
                        docker compose down || true
                        docker compose build

                        docker compose up -d mysql
                        MYSQL_CID="$(docker compose ps -q mysql || true)"
                        if [ -z "$MYSQL_CID" ]; then
                          echo "No se encontró el contenedor mysql"
                          exit 1
                        fi

                        echo "Esperando a que MySQL quede healthy..."
                        for i in $(seq 1 60); do
                          STATUS="$(docker inspect -f '{{.State.Health.Status}}' "$MYSQL_CID" 2>/dev/null || echo missing)"
                          if [ "$STATUS" = healthy ]; then
                            echo "MySQL healthy ✅"
                            break
                          fi
                          echo "MySQL status: $STATUS (intento $i/60)"
                          sleep 3
                        done

                        STATUS="$(docker inspect -f '{{.State.Health.Status}}' "$MYSQL_CID" 2>/dev/null || echo missing)"
                        if [ "$STATUS" != healthy ]; then
                          echo "MySQL no llegó a healthy ❌"
                          docker compose logs mysql || true
                          exit 1
                        fi
                    '''
                }
            }
        }

        stage('Start apps') {
            steps {
                dir("${env.TARGET_DIR}") {
                    sh '''
                        set -e
                        docker compose up -d mycar-server mycar-admin mycar-cliente
                        docker compose ps
                    '''
                }
            }
        }

        stage('Healthcheck API') {
            steps {
                dir("${env.TARGET_DIR}") {
                    sh '''
                        set -e
                        API_URL="http://${HOST_IP:-localhost}:9300/actuator/health"
                        echo "Chequeando API en: $API_URL"

                        for i in $(seq 1 60); do
                          if curl -fsS "$API_URL" >/dev/null 2>&1; then
                            echo "API UP ✅"
                            exit 0
                          fi
                          echo "Esperando API... ($i/60)"
                          sleep 3
                        done

                        echo "Healthcheck de la API FALLÓ ❌"
                        docker compose logs mycar-server || true
                        exit 1
                    '''
                }
            }
        }
    }

    post {
        always {
            dir("${env.TARGET_DIR ?: env.SUBDIR}") {
                sh '''
                    docker compose logs --no-color > compose.logs || true
                    docker compose logs mysql --no-color > mysql.logs || true
                    docker compose logs mycar-server --no-color > mycar-server.logs || true
                    docker compose logs mycar-admin --no-color > mycar-admin.logs || true
                    docker compose logs mycar-cliente --no-color > mycar-cliente.logs || true
                '''
            }
            archiveArtifacts artifacts: "${env.TARGET_DIR ?: env.SUBDIR}/**/*.logs, ${env.TARGET_DIR ?: env.SUBDIR}/*.logs, *.logs", allowEmptyArchive: true
        }
        success {
            echo '✅ Deploy OK'
        }
        failure {
            echo '❌ Deploy fallido'
        }
    }
}
