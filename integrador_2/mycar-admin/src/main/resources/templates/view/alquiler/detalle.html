<!DOCTYPE html>
<html lang="es" data-pc-preset="preset-1" data-pc-sidebar-caption="true"
      data-pc-direction="ltr" dir="ltr" data-pc-theme="light"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title>Detalle de Alquiler | MyCar Admin</title>

    <link rel="stylesheet" th:href="@{/assets/css/style.css}" id="main-style-link" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Open Sans', sans-serif;
        }

		.page-header {
		    background: #f9fafb; /* gris claro */
		    border-radius: 10px;
		    padding: 25px 30px;
		    color: #111827; /* texto oscuro */
		    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
		    border: 1px solid #e5e7eb; /* línea sutil */
		}


        .page-header h5 {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .page-header .breadcrumb-item a {
            color: #cbd5e1;
        }

        .page-header .breadcrumb-item.active {
            color: #fff;
        }

        .card {
            border: none;
            border-radius: 10px;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transition: all 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        .card-header {
            border: none;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            font-size: 16px;
        }

        .bg-gradient-primary {
            background: linear-gradient(90deg, #2563eb, #1e3a8a);
            color: white;
        }

        .bg-gradient-success {
            background: linear-gradient(90deg, #16a34a, #065f46);
            color: white;
        }

        .bg-gradient-warning {
            background: linear-gradient(90deg, #f59e0b, #b45309);
            color: white;
        }

        .list-group-item {
            border: none;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        .list-group-item:last-child {
            border-bottom: none;
        }

        .btn {
            border-radius: 6px;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #2563eb;
            border: none;
        }

        .btn-primary:hover {
            background-color: #1e40af;
        }

        .btn-warning {
            background-color: #f59e0b;
            border: none;
            color: #fff;
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        .alert {
            border-radius: 8px;
            padding: 15px 20px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #dcfce7;
            color: #15803d;
        }

        .alert-danger {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .info-icon {
            font-size: 40px;
            color: #2563eb;
            opacity: 0.8;
        }

        .label-muted {
            color: #6b7280;
            font-size: 14px;
        }

        .form-label {
            font-weight: 500;
        }

        @media (max-width: 992px) {
            .grid {
                display: block !important;
            }
        }
		
		.vehicle-image-container {
		    width: 100%;
		    height: 200px;
		    overflow: hidden;
		    border-bottom: 1px solid #eee;
		    background-color: #f8fafc; /* tono suave de fondo */
		}

		.vehicle-image {
		    width: 100%;
		    height: 100%;
		    object-fit: cover;
		    transition: transform 0.3s ease-in-out;
		}

		.vehicle-image:hover {
		    transform: scale(1.05);
		}
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div th:replace="fragments/layout :: sidebar"></div>

    <!-- Header -->
    <div th:replace="fragments/layout :: header"></div>

    <!-- Main -->
    <div class="pc-container">
        <div class="pc-content">

            <!-- Header con breadcrumb -->
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5>Detalle del Alquiler</h5>
                        <!--<ul class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a th:href="@{/dashboard}">Inicio</a></li>
                            <li class="breadcrumb-item"><a th:href="@{/alquiler/listar}">Alquileres</a></li>
                            <li class="breadcrumb-item active">Detalle</li>-->
                        </ul>
                    </div>
                    <!--<a th:href="@{/alquiler/listar}" class="btn btn-light text-dark">
                        <i class="ti ti-arrow-left"></i> Volver
                    </a>-->
                </div>
            </div>

            <!-- Mensajes -->
            <div class="mt-4" th:if="${msgExito != null}">
                <div class="alert alert-success shadow-sm" role="alert">
                    <i class="ti ti-check me-2"></i>
                    <span th:text="${msgExito}">Operación exitosa.</span>
                </div>
            </div>
            <div class="mt-4" th:if="${msgError != null}">
                <div class="alert alert-danger shadow-sm" role="alert">
                    <i class="ti ti-alert-triangle me-2"></i>
                    <span th:text="${msgError}">Ocurrió un error al procesar la solicitud.</span>
                </div>
            </div>

			<!-- Contenido principal -->
			<div class="grid grid-cols-12 gap-6 mt-4">

			    <!-- Cliente -->
			    <div class="col-span-12 xl:col-span-4 md:col-span-6">
			        <div class="card h-100">
			            <div class="card-header bg-gradient-primary">
			                <i class="ti ti-user me-2"></i> Datos del Cliente
			            </div>
			            <div class="card-body">
			                <ul class="list-group list-group-flush">
			                    <li class="list-group-item">
			                        <strong>Nombre:</strong>
			                        <span th:text="${alquiler.cliente.nombre + ' ' + alquiler.cliente.apellido}">Juan Pérez</span>
			                    </li>
			                    <li class="list-group-item">
			                        <strong>DNI:</strong>
			                        <span th:text="${alquiler.cliente.numeroDocumento}">12345678</span>
			                    </li>
			                    <li class="list-group-item">
			                        <strong>Dirección:</strong>
			                        <span th:text="${alquiler.cliente.direccionEstadia}">Calle Falsa 123</span>
			                    </li>
			                </ul>
			            </div>
			        </div>
			    </div>

				<!-- Vehículo -->
				<div class="col-span-12 xl:col-span-4 md:col-span-6">
				    <div class="card h-100 overflow-hidden">
				        <div class="card-header bg-gradient-success">
				            <i class="ti ti-car me-2"></i> Vehículo
				        </div>

				        <!-- Imagen del vehículo -->
				        <div class="vehicle-image-container">
				            <img th:src="@{${alquiler.vehiculo.caracteristicaVehiculo.imagen}}"
				                 alt="Vehículo"
				                 class="vehicle-image">
				        </div>

				        <!-- Información -->
				        <div class="card-body text-center">
				            <h5 class="mb-1" th:text="${alquiler.vehiculo.caracteristicaVehiculo.marca + ' ' + alquiler.vehiculo.caracteristicaVehiculo.modelo}"></h5>
				            <p class="label-muted mb-3" th:text="'Patente: ' + ${alquiler.vehiculo.patente}"></p>
				            <div class="d-flex justify-content-between px-3">
				                <span><strong>Puertas:</strong> <span th:text="${alquiler.vehiculo.caracteristicaVehiculo.cantidadPuerta}">4</span></span>
				                <span><strong>Asientos:</strong> <span th:text="${alquiler.vehiculo.caracteristicaVehiculo.cantidadAsiento}">5</span></span>
				                <span><strong>Año:</strong> <span th:text="${alquiler.vehiculo.caracteristicaVehiculo.anio}">2023</span></span>
				            </div>
				        </div>
				    </div>
				</div>


			    <!-- Fechas y Costo -->
			    <div class="col-span-12 xl:col-span-4 md:col-span-6">
			        <div class="card h-100" >
			            <div class="card-header bg-gradient-warning d-flex justify-content-between align-items-center">
			                <div><i class="ti ti-calendar me-2"></i> Fechas y Costo</div>
			                <button type="button" id="btnEditar" class="btn btn-light btn-sm text-dark" onclick="mostrarFormularioEdicion()">
			                    <i class="ti ti-edit me-1"></i>Editar
			                </button>
			            </div>
						
						<!-- Vista informativa -->
			            <div class="card-body" id="vistaInfo">
							
			                <ul class="list-group list-group-flush">
			                    <li class="list-group-item">
			                        <strong>Fecha Desde:</strong>
			                        <span th:text="${#temporals.format(alquiler.fechaDesde, 'dd/MM/yyyy')}">01/11/2025</span>
			                    </li>
			                    <li class="list-group-item">
			                        <strong>Fecha Hasta:</strong>
			                        <span th:text="${#temporals.format(alquiler.fechaHasta, 'dd/MM/yyyy')}">07/11/2025</span>
			                    </li>
			                    <li class="list-group-item">
			                        <strong>Cantidad de Días:</strong>
			                        <span th:text="${alquiler.cantidadDias}">7</span>
			                    </li>
			                    <li class="list-group-item">
			                        <strong>Costo Total:</strong>
			                        $<span th:text="${alquiler.costoCalculado}">150000</span>
			                    </li>
			                </ul>
							
						</div>
						
						<!-- Formulario de edición -->
			            <div class="card-body" id="formEdicion" style="display:none;">
			                <form th:action="@{/alquiler/modificar}" th:object="${alquiler}" method="post">
			                    <input type="hidden" th:field="*{id}">
			                    <!--<div class="mb-3">
			                        <label class="form-label fw-semibold">Fecha Desde</label>
			                        <input type="date" class="form-control" th:field="*{fechaDesde}" id="fechaDesdeInput">
			                    </div>
			                    <div class="mb-3">
			                        <label class="form-label fw-semibold">Fecha Hasta</label>
			                        <input type="date" class="form-control" th:field="*{fechaHasta}" id="fechaHastaInput">
			                    </div>-->
								
								<!-- Fecha de alquiler -->
								<div class="col-span-12 md:col-span-6">
								    <label for="fechasAlquiler" class="form-label">Fechas de Alquiler</label>
								    <input type="text" id="fechasAlquiler" class="form-control" placeholder="Selecciona fechas" required onfocus="this.blur()">
								    <!-- Hidden para enviar fechas por separado -->
								    <input type="hidden" id="fechaDesde" th:field="*{fechaDesde}">
								    <input type="hidden" id="fechaHasta" th:field="*{fechaHasta}">
								</div>
								
			                    <div class="mb-3">
			                        <label class="form-label fw-semibold">Cantidad de Días</label>
			                        <input type="text" class="form-control" id="diasInput" th:field="*{cantidadDias}" readonly>
			                    </div>
			                    <div class="mb-3">
			                        <label class="form-label fw-semibold">Costo Calculado</label>
			                        <div class="input-group">
			                            <span class="input-group-text">$</span>
			                            <input type="text" class="form-control" id="costoInput" th:field="*{costoCalculado}" readonly>
			                        </div>
			                    </div>
			                    <div class="d-flex gap-2">
			                        <button type="submit" class="btn btn-primary w-50">
			                            <i class="ti ti-device-floppy me-1"></i>Guardar
			                        </button>
			                        <button type="button" class="btn btn-secondary w-50" onclick="cancelarEdicion()">
			                            <i class="ti ti-x me-1"></i>Cancelar
			                        </button>
			                    </div>
			                </form>
			            </div>
			        </div>
			    </div>

			    <!-- Documentación -->
			    <div class="col-span-12 mt-6">
			        <div class="card">
			            <div class="card-header bg-gradient-primary">
			                <i class="ti ti-file-description me-2"></i> Documentación del Alquiler
			            </div>
			            <div class="card-body">
			                <form th:action="@{/documentacion/modificar}" th:object="${documentacion}" method="post" enctype="multipart/form-data">
			                    <input type="hidden" th:field="*{id}">
			                    <div class="grid grid-cols-12 gap-4">
			                        <div class="col-span-12 md:col-span-4">
			                            <label class="form-label">Tipo de Documentación</label>
			                            <select class="form-select" th:field="*{tipoDocumentacion}">
			                                <option value="">Seleccione...</option>
			                                <option th:each="tipo : ${T(com.example.mycar.mycar_admin.domain.enums.TipoDocumentacion).values()}"
			                                        th:value="${tipo}" th:text="${tipo}"></option>
			                            </select>
			                        </div>
			                        <div class="col-span-12 md:col-span-4">
			                            <label class="form-label">Observación</label>
			                            <input type="text" class="form-control" th:field="*{observacion}" placeholder="Escriba una observación...">
			                        </div>
			                        <div class="col-span-12 md:col-span-4">
			                            <label class="form-label">Archivo PDF</label>
			                            <input type="file" class="form-control" th:field="*{pdf}" accept=".pdf">
										<div th:if="${alquiler.documentacion != null}">
										    <a class="btn btn-outline-primary"
										       th:href="@{'http://localhost:9000/api/v1/documentacion/ver-pdf/' + ${alquiler.documentacion.nombreArchivo}}"
										       target="_blank">
										       <i class="ti ti-file"></i> Ver PDF
										    </a>
										</div>

			                        </div>
			                    </div>
			                    <div class="text-end mt-4">
			                        <button type="submit" class="btn btn-warning">
			                            <i class="ti ti-refresh me-2"></i>Actualizar Documentación
			                        </button>
			                    </div>
			                </form>
			            </div>
			        </div>
			    </div>
			</div>

    </div>

    <div th:replace="fragments/layout :: footer"></div>

    <script th:src="@{/assets/js/plugins/simplebar.min.js}"></script>
    <script th:src="@{/assets/js/plugins/popper.min.js}"></script>
    <script th:src="@{/assets/js/plugins/feather.min.js}"></script>
    <script th:src="@{/assets/js/component.js}"></script>
    <script th:src="@{/assets/js/theme.js}"></script>
    <script th:src="@{/assets/js/script.js}"></script>
	
	<!-- Flatpickr CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	
	<script th:inline="javascript">
	    const costoPorDia = /*[[${alquiler.vehiculo.caracteristicaVehiculo.costoVehiculo.costo}]]*/ 0;
	    console.log("Costo día:", costoPorDia);
	</script>

	
	<script >
		
	    function mostrarFormularioEdicion() {
	        document.getElementById("vistaInfo").style.display = "none";
	        document.getElementById("formEdicion").style.display = "block";
	        document.getElementById("btnEditar").style.display = "none";

	        const desde = document.getElementById("fechaDesde");
	        const hasta = document.getElementById("fechaHasta");

	        desde.addEventListener("change", recalcular);
	        hasta.addEventListener("change", recalcular);
	    }

	    function cancelarEdicion() {
	        document.getElementById("vistaInfo").style.display = "block";
	        document.getElementById("formEdicion").style.display = "none";
	        document.getElementById("btnEditar").style.display = "inline-block";
	    }

		function recalcular() {
		       const startVal = document.getElementById("fechaDesde").value;
		       const endVal   = document.getElementById("fechaHasta").value;

		       const diasInput = document.getElementById("diasInput");
		       const costoInput = document.getElementById("costoInput");

		       if (!startVal || !endVal) {
		           diasInput.value = "";
		           costoInput.value = "";
		           return;
		       }

		       const start = new Date(startVal);
		       const end   = new Date(endVal);

		       if (end < start) {
		           diasInput.value = "";
		           costoInput.value = "";
		           return;
		       }

		       const diffTime = end - start;
		       const dias = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

		       diasInput.value = dias;
		       
			   // Calcular costo
	           const total = dias * costoPorDia;
	           costoInput.value = total.toFixed(2);
			   
			   console.log("Recalculado:", { start, end, dias, costoPorDia, total });
		}
		
		// Fechas disponibles (puedes inyectarlas desde Thymeleaf)
	    let fechasDisponibles = /*[[${fechasDisponibles}]]*/ ["2025-11-12","2025-11-13","2025-11-14", "2025-11-15","2025-11-16", "2025-11-18"];

	    // Convertimos fechas a objetos Date para comparación
	    let fechasDisponiblesObj = fechasDisponibles.map(d => new Date(d + "T00:00:00"));

	    function isAvailable(date) {
	        const dateStr = date.toISOString().split('T')[0];
	        return fechasDisponibles.includes(dateStr);
	    }

	    flatpickr("#fechasAlquiler", {
	        mode: "range",
	        dateFormat: "Y-m-d",
	        disable: [
	            function(date) {
	                return !isAvailable(date); // Deshabilitar fechas no disponibles
	            }
	        ],
	        onDayCreate: function(dObj, dStr, fp, dayElem) {
	            const dateStr = dayElem.dateObj.toISOString().split('T')[0];
	            if (isAvailable(dayElem.dateObj)) {
	                dayElem.style.backgroundColor = "#3b82f6"; // azul
	                dayElem.style.color = "#fff";
	                dayElem.style.borderRadius = "50%";
	            } else {
	                dayElem.style.color = "#a1a1aa"; // gris
	                dayElem.style.cursor = "not-allowed";
	            }
	        },
	        onChange: function(selectedDates, dateStr, instance) {
				const fechaDesdeInput = document.querySelector("input[name='fechaDesde']");
	            const fechaHastaInput = document.querySelector("input[name='fechaHasta']");

	            // Si seleccionó una sola fecha
	            if (selectedDates.length === 1) {
	               const fecha = selectedDates[0].toISOString().split('T')[0];
	               fechaDesdeInput.value = fecha;
	               fechaHastaInput.value = fecha;
	            }

				
	            if(selectedDates.length === 2){
	                let start = selectedDates[0];
	                let end = selectedDates[1];
					
					fechaDesdeInput.value = start.toISOString().split("T")[0];
					fechaHastaInput.value = end.toISOString().split("T")[0];

		            recalcular(start, end);

	                // Validar que todas las fechas entre start y end estén disponibles
	                let current = new Date(start);
	                let valid = true;
	                while(current <= end){
	                    const currentStr = current.toISOString().split('T')[0];
	                    if(!fechasDisponibles.includes(currentStr)){
	                        valid = false;
	                        break;
	                    }
	                    current.setDate(current.getDate() + 1);
	                }

	                if(!valid){
	                    alert("El rango seleccionado contiene fechas no disponibles. Por favor selecciona solo fechas disponibles consecutivas.");
	                    instance.clear();
	                    document.querySelector("input[name='fechaDesde']").value = "";
	                    document.querySelector("input[name='fechaHasta']").value = "";
	                } else {
	                    document.querySelector("input[name='fechaDesde']").value = start.toISOString().split('T')[0];
	                    document.querySelector("input[name='fechaHasta']").value = end.toISOString().split('T')[0];
	                }
	            }
	        }
	    });
	</script>
</body>
</html>
