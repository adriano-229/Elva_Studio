<!DOCTYPE html>
<html data-pc-direction="ltr" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-theme="light" dir="ltr"
      lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Cotización | Tu Aplicación</title>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" name="viewport"/>
  <link href="../assets/css/style.css" id="main-style-link" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>

  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f5f6fa;
      color: #333;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 20px;
      margin-bottom: 20px;
    }

    .card-header {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 8px;
    }

    .form-label {
      font-weight: 500;
      margin-bottom: 6px;
      display: block;
    }

    .form-control, .form-select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      margin-bottom: 15px;
      transition: border 0.3s, box-shadow 0.3s;
    }

    .form-control:focus, .form-select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
    }

    #btnContinuar {
      margin-top: 10px;
      padding: 0.25rem 0.5rem;
    }
  </style>

</head>

<body>

<!-- Sidebar -->
<div th:replace="fragments/layout :: sidebar"></div>

<!-- Navbar -->
<div th:replace="fragments/layout :: navbar"></div>

<!-- Main Content -->
<div class="pc-container">
  <div class="pc-content">

    <!-- Breadcrumb -->
    <div class="page-header">
      <div class="page-block">
        <div class="page-header-title">
          <h5 class="mb-0 font-medium">Cotización de Vehículo</h5>

          <!-- Mensajes de error -->
          <div class="mb-4" th:if="${msgError != null}">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="me-2" data-feather="alert-circle"></i>
              <span th:text="${msgError}">Error al procesar la solicitud</span>
              <button aria-label="Cerrar" class="btn-close" data-bs-dismiss="alert" type="button"></button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="grid grid-cols-12 gap-x-6 mt-4">

      <!-- Formulario Cotización -->
      <div class="col-span-12 xl:col-span-8 md:col-span-12">
        <div class="card">
          <div class="card-header">
            <h5>Formulario de Cotización</h5>
          </div>
          <div class="card-body">
            <form class="grid grid-cols-12 gap-4" method="post" th:action="@{/alquiler/cotizar}"
                  th:object="${alquiler}">

              <!-- Selección de Auto -->
              <div class="col-span-12 md:col-span-6">
                <label class="form-label" for="auto">Selecciona un auto</label>
                <select class="form-select" id="auto" th:field="*{idVehiculo}">
                  <option disabled selected value="">-- Elige un vehículo --</option>
                  <option th:each="auto : ${listaVehiculos}"
                          th:text="${auto.caracteristicaVehiculo.marca} + ' - ' + ${auto.caracteristicaVehiculo.modelo} + ' - ' + ${auto.patente}"
                          th:value="${auto.id}">
                    Auto 1
                  </option>
                </select>
              </div>

              <!-- Fecha de alquiler -->
              <div class="col-span-12 md:col-span-6">
                <label class="form-label" for="fechasAlquiler">Fechas de Alquiler</label>
                <input class="form-control" id="fechasAlquiler" name="fechasAlquiler" onfocus="this.blur()"
                       placeholder="Selecciona fechas" required type="text">
                <!-- Hidden para enviar fechas por separado -->
                <input name="fechaDesde" th:field="*{fechaDesde}" th:value="*{fechaDesde}" type="hidden">
                <input name="fechaHasta" th:field="*{fechaHasta}" th:value="*{fechaHasta}" type="hidden">
              </div>

              <!-- Cupón de descuento -->
              <div class="col-span-12 md:col-span-6">
                <label class="form-label" for="cupon">Cupón de Descuento (opcional)</label>
                <input class="form-control" id="cupon" placeholder="Ingresa tu cupón" th:field="*{codigoDescuento}"
                       type="text">
              </div>

              <!-- Botón Cotizar -->
              <div class="col-span-12 mt-4">
                <button class="btn btn-primary" type="submit">
                  <i class="mr-2"></i> Cotizar
                </button>
              </div>

            </form>
          </div>
        </div>
      </div>

      <!-- Detalle de Cotización -->
      <div class="col-span-12 xl:col-span-4 md:col-span-12" th:if="${alquilerCotizado != null}">
        <div class="card">
          <form method="post" th:action="@{/alquiler/crearConCotizacion}" th:object="${alquilerCotizado}">
            <input th:field="*{idVehiculo}" type="hidden">
            <input th:field="*{fechaDesde}" type="hidden">
            <input th:field="*{fechaHasta}" type="hidden">
            <input th:field="*{subtotal}" type="hidden">
            <input th:field="*{porcentajeDescuento}" type="hidden">
            <input th:field="*{totalConDescuento}" type="hidden">
            <input th:field="*{codigoDescuento}" type="hidden">
            <input th:field="*{cantidadDias}" type="hidden">

            <div class="card-header">
              <h5>Detalle de Cotización</h5>
            </div>
            <div class="card-body">
              <p>Selecciona un vehículo y las fechas para ver el resumen de la cotización.</p>

              <div class="mt-4" id="detalle-cotizacion" th:if="${vehiculoSeleccionado != null}">
                <!-- Imagen del vehículo -->
                <div class="text-center mb-3">
                  <img alt="Imagen del vehículo"
                       class="vehiculo-img"
                       th:src="@{${vehiculoSeleccionado.caracteristicaVehiculo.imagen}}">
                </div>

                <!-- Datos vehículo -->
                <div class="text-center mb-3">
                  <h5 th:text="${vehiculoSeleccionado.caracteristicaVehiculo.marca} + ' ' + ${vehiculoSeleccionado.caracteristicaVehiculo.modelo}"></h5>
                  <p class="text-muted" th:text="'Patente: ' + ${vehiculoSeleccionado.patente}">Patente</p>
                </div>

                <!-- Fechas -->
                <div class="grid grid-cols-2 gap-3 mb-3 text-center">
                  <div>
                    <label class="form-label d-block">Desde</label>
                    <span th:text="${#temporals.format(alquilerCotizado.fechaDesde, 'yyyy-MM-dd')}"></span>
                  </div>
                  <div>
                    <label class="form-label d-block">Hasta</label>
                    <span th:text="${#temporals.format(alquilerCotizado.fechaHasta, 'yyyy-MM-dd')}"></span>
                  </div>
                </div>

                <!-- Totales -->
                <div class="mb-2 flex justify-between">
                  <span>Subtotal:</span>
                  <span>$<span th:text="${alquilerCotizado.subtotal}">0</span></span>
                </div>
                <div class="mb-2 flex justify-between">
                  <span>Descuento:</span>
                  <span>$<span th:text="${alquilerCotizado.descuento}">0</span></span>
                </div>
                <div class="mb-4 flex justify-between font-bold">
                  <span>Total:</span>
                  <span>$<span th:text="${alquilerCotizado.totalConDescuento}">0</span></span>
                </div>
              </div>

              <!--Busqueda cliente-->
              <div class="card mt-4">
                <div class="card-header">
                  <h5>Buscar Cliente</h5>
                </div>
                <div class="card-body">
                  <div class="input-group mb-3">
                    <input class="form-control" id="dniBuscar" placeholder="Ingrese DNI del cliente" required
                           type="text">
                    <button class="btn btn-success" onclick="buscarCliente()" type="button">Buscar</button>
                  </div>
                  <div id="resultadoCliente"></div>
                  <input id="clienteId" name="idCliente" required th:field="*{idCliente}" type="hidden">
                </div>
              </div>

              <!-- Botón de alquilar -->
              <div class="text-center">
                <button class="btn btn-primary btn-sm" disabled id="btnContinuar" type="submit">Continuar</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<div th:replace="fragments/layout :: footer"></div>

<!-- JS Scripts -->
<script src="../assets/js/plugins/simplebar.min.js"></script>
<script src="../assets/js/plugins/popper.min.js"></script>
<script src="../assets/js/plugins/feather.min.js"></script>
<script src="../assets/js/component.js"></script>
<script src="../assets/js/theme.js"></script>
<script src="../assets/js/script.js"></script>

<!-- Flatpickr CSS -->
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    const listaClientes = /*[[${listaClientes}]]*/ [];
    let fechasDisponibles = /*[[${fechasDisponibles}]]*/ ["2025-11-12", "2025-11-13", "2025-11-15", "2025-11-16"];
    /*]]>*/

    function isAvailable(date) {
        const dateStr = date.toISOString().split('T')[0];
        return fechasDisponibles.includes(dateStr);
    }

    flatpickr("#fechasAlquiler", {
        mode: "range",
        dateFormat: "Y-m-d",
        disable: [
            function (date) {
                return !isAvailable(date);
            }
        ],
        onDayCreate: function (dObj, dStr, fp, dayElem) {
            if (isAvailable(dayElem.dateObj)) {
                dayElem.style.backgroundColor = "#3b82f6";
                dayElem.style.color = "#fff";
                dayElem.style.borderRadius = "50%";
            } else {
                dayElem.style.color = "#a1a1aa";
                dayElem.style.cursor = "not-allowed";
            }
        },
        onChange: function (selectedDates, dateStr, instance) {
            const fechaDesdeInput = document.querySelector("input[name='fechaDesde']");
            const fechaHastaInput = document.querySelector("input[name='fechaHasta']");

            if (selectedDates.length === 1) {
                const fecha = selectedDates[0].toISOString().split('T')[0];
                fechaDesdeInput.value = fecha;
                fechaHastaInput.value = fecha;
            }

            if (selectedDates.length === 2) {
                let start = selectedDates[0];
                let end = selectedDates[1];

                let current = new Date(start);
                let valid = true;
                while (current <= end) {
                    const currentStr = current.toISOString().split('T')[0];
                    if (!fechasDisponibles.includes(currentStr)) {
                        valid = false;
                        break;
                    }
                    current.setDate(current.getDate() + 1);
                }

                if (!valid) {
                    alert("El rango seleccionado contiene fechas no disponibles. Selecciona fechas consecutivas válidas.");
                    instance.clear();
                    fechaDesdeInput.value = "";
                    fechaHastaInput.value = "";
                } else {
                    fechaDesdeInput.value = start.toISOString().split('T')[0];
                    fechaHastaInput.value = end.toISOString().split('T')[0];
                }
            }
        }
    });

    function buscarCliente() {
        const dni = document.getElementById('dniBuscar').value.trim();
        const contenedor = document.getElementById('resultadoCliente');

        if (!dni) {
            contenedor.innerHTML = `<p class="text-danger mt-2">Por favor ingresa un DNI.</p>`;
            return;
        }

        const cliente = listaClientes.find(c => c.numeroDocumento == dni);

        if (!cliente) {
            contenedor.innerHTML = `<p class="text-danger mt-2">No se encontró ningún cliente con ese DNI.</p>`;
            return;
        }

        contenedor.innerHTML = `
            <div class="card mt-2">
                <div class="card-body p-2">
                    <strong>${cliente.nombre} ${cliente.apellido}</strong><br>
                    DNI: ${cliente.numeroDocumento}<br>
                    <button class="btn btn-success btn-sm float-end mt-1"
                            onclick="seleccionarCliente(${cliente.id}, '${cliente.nombre}', '${cliente.apellido}', '${cliente.numeroDocumento}')">
                        Seleccionar
                    </button>
                </div>
            </div>
        `;
    }

    function seleccionarCliente(id, nombre, apellido, dni) {
        document.getElementById('clienteId').value = id;
        document.getElementById('resultadoCliente').innerHTML = `
            <div class="alert alert-success mt-2">
                Cliente seleccionado: <strong>${nombre} ${apellido}</strong> (DNI: ${dni})
            </div>
        `;
        document.getElementById("btnContinuar").disabled = false;
    }
</script>

</body>
</html>
