<!DOCTYPE html>
<html data-pc-direction="ltr" data-pc-preset="preset-1" data-pc-sidebar-caption="true" data-pc-theme="light" dir="ltr"
      lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Cotización | Tu Aplicación</title>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui" name="viewport"/>
  <link href="../assets/css/style.css" id="main-style-link" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>

</head>

<body>

<!-- Sidebar -->
<div th:replace="fragments/layout :: sidebar"></div>

<!-- Header -->
<div th:replace="fragments/layout :: header"></div>

<!-- Main Content -->
<div class="pc-container">
  <div class="pc-content">

    <!-- Breadcrumb -->
    <div class="page-header">
      <div class="page-block">
        <div class="page-header-title">
          <h5 class="mb-0 font-medium">Cotización de Vehículo</h5>

          <!-- Mensajes de error -->
          <div class="mb-4" th:if="${msgError != null}">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="me-2" data-feather="alert-circle"></i>
              <span th:text="${msgError}">Error al procesar la solicitud</span>
              <button aria-label="Cerrar" class="btn-close" data-bs-dismiss="alert" type="button"></button>
            </div>
          </div>

        </div>
        <!--<ul class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/dashboard}">Home</a></li>
            <li class="breadcrumb-item" aria-current="page">Cotización</li>
        </ul>-->
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="grid grid-cols-12 gap-x-6 mt-4">

      <!-- Formulario Cotización -->
      <div class="col-span-12 xl:col-span-8 md:col-span-12">
        <div class="card">
          <div class="card-header">
            <h5>Formulario de Cotización</h5>
          </div>
          <div class="card-body">
            <form class="grid grid-cols-12 gap-4" method="post" th:action="@{/alquiler/cotizar}"
                  th:object="${alquiler}">

              <!-- Selección de Auto -->
              <div class="col-span-12 md:col-span-6">
                <label class="form-label" for="auto">Selecciona un auto</label>
                <select class="form-select" id="auto" th:field="*{idVehiculo}">
                  <option disabled selected value="">-- Elige un vehículo --</option>
                  <option th:each="auto : ${listaVehiculos}" th:text="${auto.caracteristicaVehiculo.marca} + ' - ' + ${auto.caracteristicaVehiculo.modelo}"
                          th:value="${auto.id}">
                    Auto 1
                  </option>
                </select>
              </div>

              <!-- Fecha de alquiler -->
              <div class="col-span-12 md:col-span-6">
                <label class="form-label" for="fechasAlquiler">Fechas de Alquiler</label>
                <input class="form-control" id="fechasAlquiler" name="fechasAlquiler" onfocus="this.blur()"
                       placeholder="Selecciona fechas" required type="text">
                <!-- Hidden para enviar fechas por separado -->
                <input name="fechaDesde" th:field="*{fechaDesde}" th:value="*{fechaDesde}" type="hidden">
                <input name="fechaHasta" th:field="*{fechaHasta}" th:value="*{fechaHasta}" type="hidden">
              </div>

              <!-- Cupón de descuento -->
              <div class="col-span-12 md:col-span-6">
                <label class="form-label" for="cupon">Cupón de Descuento (opcional)</label>
                <input class="form-control" id="cupon" placeholder="Ingresa tu cupón" th:field="*{codigoDescuento}"
                       type="text">
              </div>

              <!-- Botón Cotizar -->
              <div class="col-span-12 mt-4">
                <button class="btn btn-primary" type="submit">
                  <i class="mr-2"></i> Cotizar
                </button>
              </div>

            </form>
          </div>
        </div>
      </div>

      <!-- Detalle de Cotización -->
      <div class="col-span-12 xl:col-span-4 md:col-span-12" th:if="${alquilerCotizado != null}">
        <div class="card">
          <form method="post" th:action="@{/alquiler/crearConCotizacion}" th:object="${alquilerCotizado}">
            <input th:field="*{idVehiculo}" type="hidden">
            <input th:field="*{fechaDesde}" type="hidden">
            <input th:field="*{fechaHasta}" type="hidden">
            <input th:field="*{subtotal}" type="hidden">
            <input th:field="*{porcentajeDescuento}" type="hidden">
            <input th:field="*{totalConDescuento}" type="hidden">
            <input th:field="*{codigoDescuento}" type="hidden">
            <input th:field="*{cantidadDias}" type="hidden">

            <div class="card-header">
              <h5>Detalle de Cotización</h5>
            </div>
            <div class="card-body">
              <p>Selecciona un vehículo y las fechas para ver el resumen de la cotización.</p>

              <div class="mt-4" id="detalle-cotizacion" th:if="${vehiculoSeleccionado != null}">
                <!-- Imagen del vehículo -->
                <div class="text-center mb-3">
                  <img alt="Imagen del vehículo" style="width:100%; max-width:300px; height:200px; object-fit:cover; border-radius:8px;"
                       th:src="@{${vehiculoSeleccionado.caracteristicaVehiculo.imagen}}">
                </div>

                <!-- Información del vehículo -->
                <h5 class="text-center mb-2"
                    th:text="${vehiculoSeleccionado.caracteristicaVehiculo.marca} + ' ' + ${vehiculoSeleccionado.caracteristicaVehiculo.modelo}"></h5>
                <p class="text-center text-muted mb-3">
                  Año: <span th:text="${vehiculoSeleccionado.caracteristicaVehiculo.anio}"></span> |
                  Costo por día: $<span
                    th:text="${vehiculoSeleccionado.caracteristicaVehiculo.costoVehiculo.costo}"></span> |
                  Dias: <span th:text="${alquilerCotizado.cantidadDias}"> dias</span>
                </p>

                <!-- Fechas de alquiler (solo mostrar, no editar) -->
                <div class="grid grid-cols-2 gap-3 mb-3 text-center">
                  <div>
                    <label class="form-label d-block">Desde</label>
                    <span th:text="${#temporals.format(alquilerCotizado.fechaDesde, 'yyyy-MM-dd')}"></span>
                  </div>
                  <div>
                    <label class="form-label d-block">Hasta</label>
                    <span th:text="${#temporals.format(alquilerCotizado.fechaHasta, 'yyyy-MM-dd')}"></span>
                  </div>
                </div>


                <!-- Totales -->
                <div class="mb-2 flex justify-between">
                  <span>Subtotal:</span>
                  <span>$<span th:text="${alquilerCotizado.subtotal}">0</span></span>
                </div>
                <div class="mb-2 flex justify-between">
                  <span>Descuento:</span>
                  <span>$<span th:text="${alquilerCotizado.descuento}">0</span></span>
                </div>
                <div class="mb-4 flex justify-between font-bold">
                  <span>Total:</span>
                  <span>$<span th:text="${alquilerCotizado.totalConDescuento}">0</span></span>
                </div>

                <!--Busqueda cliente-->
                <div class="col-span-12 xl:col-span-4 md:col-span-12" th:if="${alquilerCotizado != null}">
                  <div class="card mt-4">
                    <div class="card-header">
                      <h5>Buscar Cliente</h5>
                    </div>
                    <div class="card-body">
                      <div class="input-group mb-3">
                        <input class="form-control" id="dniBuscar" placeholder="Ingrese DNI del cliente" required
                               type="text">
                        <button class="btn btn-primary" onclick="buscarCliente()" type="button">Buscar</button>
                      </div>
                      <div id="resultadoCliente"></div>
                      <input id="clienteId" name="idCliente" required th:field="*{idCliente}" type="hidden">
                    </div>
                  </div>
                </div>


                <!-- Botón de alquilar -->
                <div class="text-center">
                  <button class="btn btn-primary w-full" disabled id="btnContinuar" type="submit">Continuar</button>

                </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
</div>

<!-- Footer -->
<div th:replace="fragments/layout :: footer"></div>

<!-- JS Scripts -->
<script src="../assets/js/plugins/simplebar.min.js"></script>
<script src="../assets/js/plugins/popper.min.js"></script>
<script src="../assets/js/plugins/feather.min.js"></script>
<script src="../assets/js/component.js"></script>
<script src="../assets/js/theme.js"></script>
<script src="../assets/js/script.js"></script>
<!--<script src="../assets/js/plugins/datepicker.min.js"></script>-->

<!-- Flatpickr CSS -->
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


<!-- Inicializar datepicker -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const listaClientes = /*[[${listaClientes}]]*/ [];
    /*]]>*/

    // Fechas disponibles (puedes inyectarlas desde Thymeleaf)
    let fechasDisponibles = /*[[${fechasDisponibles}]]*/ ["2025-11-12", "2025-11-13", "2025-11-15", "2025-11-16"];

    // Convertimos fechas a objetos Date para comparación
    let fechasDisponiblesObj = fechasDisponibles.map(d => new Date(d + "T00:00:00"));

    function isAvailable(date) {
        const dateStr = date.toISOString().split('T')[0];
        return fechasDisponibles.includes(dateStr);
    }

    flatpickr("#fechasAlquiler", {
        mode: "range",
        dateFormat: "Y-m-d",
        disable: [
            function (date) {
                return !isAvailable(date); // Deshabilitar fechas no disponibles
            }
        ],
        onDayCreate: function (dObj, dStr, fp, dayElem) {
            const dateStr = dayElem.dateObj.toISOString().split('T')[0];
            if (isAvailable(dayElem.dateObj)) {
                dayElem.style.backgroundColor = "#3b82f6"; // azul
                dayElem.style.color = "#fff";
                dayElem.style.borderRadius = "50%";
            } else {
                dayElem.style.color = "#a1a1aa"; // gris
                dayElem.style.cursor = "not-allowed";
            }
        },
        onChange: function (selectedDates, dateStr, instance) {
            const fechaDesdeInput = document.querySelector("input[name='fechaDesde']");
            const fechaHastaInput = document.querySelector("input[name='fechaHasta']");

            // Si seleccionó una sola fecha
            if (selectedDates.length === 1) {
                const fecha = selectedDates[0].toISOString().split('T')[0];
                fechaDesdeInput.value = fecha;
                fechaHastaInput.value = fecha;
            }


            if (selectedDates.length === 2) {
                let start = selectedDates[0];
                let end = selectedDates[1];

                // Validar que todas las fechas entre start y end estén disponibles
                let current = new Date(start);
                let valid = true;
                while (current <= end) {
                    const currentStr = current.toISOString().split('T')[0];
                    if (!fechasDisponibles.includes(currentStr)) {
                        valid = false;
                        break;
                    }
                    current.setDate(current.getDate() + 1);
                }

                if (!valid) {
                    alert("El rango seleccionado contiene fechas no disponibles. Por favor selecciona solo fechas disponibles consecutivas.");
                    instance.clear();
                    document.querySelector("input[name='fechaDesde']").value = "";
                    document.querySelector("input[name='fechaHasta']").value = "";
                } else {
                    document.querySelector("input[name='fechaDesde']").value = start.toISOString().split('T')[0];
                    document.querySelector("input[name='fechaHasta']").value = end.toISOString().split('T')[0];
                }
            }
        }
    });

    function buscarCliente() {
        const dni = document.getElementById('dniBuscar').value.trim();
        const contenedor = document.getElementById('resultadoCliente');

        if (!dni) {
            contenedor.innerHTML = `<p class="text-danger mt-2">Por favor ingresa un DNI.</p>`;
            return;
        }

        const cliente = listaClientes.find(c => c.numeroDocumento == dni);

        if (!cliente) {
            contenedor.innerHTML = `<p class="text-danger mt-2">No se encontró ningún cliente con ese DNI.</p>`;
            return;
        }

        contenedor.innerHTML = `
		        <div class="card mt-2">
		            <div class="card-body p-2">
		                <strong>${cliente.nombre} ${cliente.apellido}</strong><br>
		                DNI: ${cliente.numeroDocumento}<br>
		                <button class="btn btn-success btn-sm float-end mt-1"
		                        onclick="seleccionarCliente(${cliente.id}, '${cliente.nombre}', '${cliente.apellido}', '${cliente.numeroDocumento}')">
		                    Seleccionar
		                </button>
		            </div>
		        </div>
		    `;
    }

    function seleccionarCliente(id, nombre, apellido, dni) {
        document.getElementById('clienteId').value = id;
        document.getElementById('resultadoCliente').innerHTML = `
		        <div class="alert alert-success mt-2">
		            Cliente seleccionado: <strong>${nombre} ${apellido}</strong> (DNI: ${dni})
		        </div>
		    `;
        document.getElementById("btnContinuar").disabled = false;
    }

</script>

</body>
</html>
